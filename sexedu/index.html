<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntiMate æ„›å¿ƒå¯†èª - é’å°‘å¹´æ€§æ•™è‚²è¼”å°å¹³å°</title>
    <!-- é©ç”¨æ–¼ iPad æ¨¡æ“¬ App çš„è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/667eea/ffffff?text=IntiMate">

    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Poppins å­—é«” - æ›´å¹´è¼•æ´»åŠ› */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        #input-area {
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .message-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Old School Styles */
        .old-school-page {
            background: #c0c0c0;
            font-family: 'Times New Roman', Times, serif;
        }
        
        .old-school-box {
            background: #ffffff;
            border: 3px solid #808080;
            box-shadow: 3px 3px 0px #000000;
        }
        
        .old-school-button {
            background: #c0c0c0;
            border: 2px outset #ffffff;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            padding: 8px 24px;
            cursor: pointer;
        }
        
        .old-school-button:active {
            border-style: inset;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .blink {
            animation: blink 1s step-start infinite;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
        }
        
        /* Transition Page Styles */
        @keyframes morphBackground {
            0% { background: #000000; }
            25% { background: #1a1a2e; }
            50% { background: #16213e; }
            75% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%); }
            100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        }
        
        @keyframes colorShift {
            0% { color: #00ff00; }
            50% { color: #00ffff; }
            75% { color: #ff00ff; }
            100% { color: #ffffff; }
        }
        
        @keyframes fontTransform {
            0% { 
                font-family: 'Courier New', monospace; 
                font-size: 18px;
            }
            100% { 
                font-family: 'Poppins', sans-serif; 
                font-size: 28px;
            }
        }
        
        .morphing-bg {
            animation: morphBackground 4s ease-in-out forwards;
        }
        
        .color-shift {
            animation: colorShift 3s ease-in-out forwards;
        }
        
        .font-transform {
            animation: fontTransform 3s ease-in-out forwards;
        }
        
        @keyframes scaleUp {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .scale-up {
            animation: scaleUp 1s ease-out forwards;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a2e;
        }
        
        .dark-mode #modern-app {
            background: #1a1a2e;
        }
        
        .dark-mode #header-bar {
            background: linear-gradient(to right, #4c1d95, #7c2d92, #be185d) !important;
        }
        
        .dark-mode main {
            background: linear-gradient(to bottom right, #1e1e2e, #2a2a3e, #1a1a2e) !important;
        }
        
        .dark-mode .bg-white {
            background: #2a2a3e !important;
        }
        
        .dark-mode .text-gray-700,
        .dark-mode .text-gray-800 {
            color: #e5e5e5 !important;
        }
        
        .dark-mode .text-gray-600 {
            color: #b0b0b0 !important;
        }
        
        .dark-mode .text-gray-500 {
            color: #888888 !important;
        }
        
        .dark-mode input {
            background: linear-gradient(to right, #3a3a52, #4a4a62) !important;
            color: #ffffff !important;
            border-color: #5a5a7a !important;
        }
        
        .dark-mode input::placeholder {
            color: #9ca3af !important;
        }
        
        .dark-mode .border-purple-200 {
            border-color: #4a4a6a !important;
        }
        
        .dark-mode .border-purple-300 {
            border-color: #5a5a7a !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-purple-50 {
            background: linear-gradient(to bottom right, #2a2a42, #3a3a52) !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-blue-50 {
            background: linear-gradient(to bottom right, #1e3a5f, #2a4a6f) !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-pink-50 {
            background: linear-gradient(to bottom right, #4a2a42, #5a3a52) !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-gray-50 {
            background: linear-gradient(to bottom right, #2a2a2a, #3a3a3a) !important;
        }
        
        .dark-mode .bg-amber-50 {
            background: #3a3a2e !important;
        }
        
        .dark-mode .border-amber-400 {
            border-color: #d97706 !important;
        }
        
        .dark-mode .text-amber-800 {
            color: #fbbf24 !important;
        }
        
        .dark-mode .text-amber-600 {
            color: #f59e0b !important;
        }
        
        /* User Info Page Dark Mode */
        .dark-mode #user-info-page {
            background: linear-gradient(135deg, #2d3561 0%, #4a3f6b 100%) !important;
        }
        
        .dark-mode #user-info-page .bg-white\/95 {
            background: rgba(30, 30, 46, 0.95) !important;
        }
        
        /* Pre-Test and Post-Test Dark Mode */
        .dark-mode #pre-test-page {
            background: linear-gradient(135deg, #2d3561 0%, #4a3f6b 100%) !important;
        }
        
        .dark-mode #pre-test-page .bg-white\/95,
        .dark-mode #post-test-view .bg-white {
            background: rgba(30, 30, 46, 0.95) !important;
        }
        
        .dark-mode .border-green-300 {
            border-color: #22c55e !important;
        }
        
        .dark-mode .border-green-200 {
            border-color: #4ade80 !important;
        }
        
        .dark-mode .text-green-600 {
            color: #4ade80 !important;
        }
        
        .dark-mode .bg-green-50 {
            background: #1a3a2e !important;
        }
        
        .dark-mode .bg-green-100 {
            background: #2a4a3e !important;
        }
        
        /* Quiz Mode Dark Mode */
        .dark-mode #quiz-mode-view .bg-white {
            background: #2a2a3e !important;
            border-color: #5a5a7a !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-purple-100 {
            background: linear-gradient(to bottom right, #2a2a42, #3a3a52) !important;
        }
        
        /* Button Hover States in Dark Mode */
        .dark-mode button:hover {
            filter: brightness(1.2);
        }
        
        .dark-mode .age-btn:hover,
        .dark-mode .gender-btn:hover {
            filter: brightness(1.15);
        }
        
        /* Ring colors in Dark Mode */
        .dark-mode .ring-purple-500 {
            --tw-ring-color: #8b5cf6 !important;
        }
        
        .dark-mode .ring-4 {
            box-shadow: 0 0 0 4px var(--tw-ring-color) !important;
        }
        
        /* Green success text in dark mode */
        .dark-mode .text-green-600 {
            color: #4ade80 !important;
        }
        
        /* Smooth theme transition */
        body {
            transition: background-color 0.3s ease;
        }
        
        #modern-app,
        main,
        input,
        button {
            transition: all 0.3s ease;
        }
        
        /* Responsive message bubbles */
        @media (max-width: 640px) {
            #messages-container > div > div {
                max-width: 85% !important;
            }
        }
    </style>
</head>
<body>

    <!-- Old School Landing Page -->
    <div id="old-school-page" class="old-school-page w-full h-screen flex items-center justify-center">
        <div class="old-school-box p-12 max-w-2xl mx-4">
            <h1 style="font-size: 24px; margin-bottom: 20px; text-align: center; font-weight: bold;">
                å…©æ€§å¥åº·è³‡è¨Šç«™ v1.0<br>
                Gender Health Information Station
            </h1>
            <hr style="border: 1px solid #808080; margin: 20px 0;">
            <p style="font-size: 16px; line-height: 1.6; margin-bottom: 30px; text-align: center;">
                Welcome to the Gender Health Information Station.<br>
                An Educational Resource for Youth Development and Wellness.<br>
                Copyright Â© 1995-2025. All Rights Reserved.<br><br>
                Press the button below to initialize the system.
            </p>
            <div style="text-align: center;">
                <button class="old-school-button" onclick="startSystem()">
                    START SYSTEM
                </button>
            </div>
            <p style="font-size: 12px; margin-top: 30px; text-align: center; color: #666;">
                System Requirements: 486DX/33MHz or higher, 8MB RAM, VGA Display
            </p>
        </div>
    </div>

    <!-- Loading/Transition Page -->
    <div id="loading-page" class="hidden w-full h-screen flex items-center justify-center bg-black">
        <div class="text-center px-4">
            <div id="loading-content" style="font-family: 'Courier New', monospace; color: #00ff00; font-size: 18px; line-height: 1.8;">
                <p id="init-text">INITIALIZING SYSTEM...</p>
                <p id="loading-text">LOADING MODULES... [<span id="progress">0</span>%]</p>
                <p class="blink" id="cursor">_</p>
            </div>
            <div id="transition-content" style="display: none; margin-top: 60px;">
                <p id="joke-text" style="font-family: 'Courier New', monospace; color: #00ff00; font-size: 24px; margin-bottom: 40px;">
                    Just kidding!<br>
                    We're not that old fashion! ğŸ˜„
                </p>
                <p id="upgrade-text" class="color-shift font-transform" style="font-family: 'Courier New', monospace; color: #00ff00; font-size: 18px; margin-top: 30px; display: none;">
                    ğŸš€ Upgrading to modern interface...<br>
                    âœ¨ Adding colors and gradients...<br>
                    ğŸ’« Initializing smooth animations...<br>
                    ğŸ¨ Loading beautiful design...
                </p>
            </div>
        </div>
    </div>

    <!-- Pre-Test Page -->
    <div id="pre-test-page" class="hidden w-full h-screen flex items-center justify-center p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="w-full max-w-3xl bg-white/95 rounded-3xl shadow-2xl p-6 md:p-10">
            <div class="text-center mb-6">
                <h2 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3">
                    ğŸ“‹ çŸ¥è­˜æ°´å¹³è©•ä¼°æ¸¬é©—
                </h2>
                <p class="text-gray-600 text-sm md:text-base">
                    åœ¨é–‹å§‹ä½¿ç”¨ IntiMate å‰ï¼Œè®“æˆ‘å€‘å…ˆäº†è§£ä¸€ä¸‹ä½ ç›®å‰çš„çŸ¥è­˜æ°´å¹³<br>
                    <span class="text-purple-600 font-semibold">é€™å°‡å¹«åŠ©æˆ‘å€‘æä¾›æ›´é©åˆä½ çš„æŒ‡å°</span>
                </p>
            </div>
            
            <div id="pre-test-content" class="space-y-4">
                <!-- Questions will be dynamically generated -->
            </div>
            
            <div id="pre-test-result" class="hidden text-center space-y-4">
                <div class="text-6xl mb-4">ğŸ“Š</div>
                <h3 class="text-2xl font-bold text-gray-800">æ¸¬é©—å®Œæˆï¼</h3>
                <p class="text-lg text-gray-600">æ­£åœ¨åˆ†æä½ çš„çµæœ...</p>
                <div class="animate-pulse">
                    <div class="h-2 bg-purple-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Info Collection Page -->
    <div id="user-info-page" class="hidden w-full h-screen flex items-center justify-center p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="w-full max-w-2xl bg-white/95 rounded-3xl shadow-2xl p-8 md:p-12">
            <h2 class="text-3xl md:text-4xl font-bold text-center mb-3 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                æ­¡è¿ä½¿ç”¨ IntiMate æ„›å¿ƒå¯†èª âœ¨
            </h2>
            <p class="text-center text-gray-600 mb-8 text-base md:text-lg">
                ç‚ºäº†æä¾›æ›´é©åˆæ‚¨çš„å»ºè­°ï¼Œè«‹å…ˆå¡«å¯«ä»¥ä¸‹è³‡è¨Š<br>
                <span class="text-sm text-purple-600 font-semibold">ï¼ˆIntiMate å°ˆç‚º10-18æ­²é’å°‘å¹´è¨­è¨ˆï¼‰</span>
            </p>

            <!-- Age Group Selection -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-700 mb-4">ğŸ“… è«‹é¸æ“‡æ‚¨çš„å¹´é½¡æ®µï¼š</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="selectAge('10-13')" id="age-10-13" class="age-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">ğŸ§’</div>
                        <div class="font-bold mb-1">10-13æ­²</div>
                        <div class="text-xs text-gray-600">æ¢ç´¢æœŸ / åŸºç¤èªçŸ¥</div>
                    </button>
                    <button onclick="selectAge('13-15')" id="age-13-15" class="age-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">ğŸ§‘</div>
                        <div class="font-bold mb-1">13-15æ­²</div>
                        <div class="text-xs text-gray-600">éæ¸¡æœŸ / ç¤¾æœƒèªçŸ¥</div>
                    </button>
                    <button onclick="selectAge('16-18')" id="age-16-18" class="age-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">ğŸ‘¨â€ğŸ“</div>
                        <div class="font-bold mb-1">16-18æ­²</div>
                        <div class="text-xs text-gray-600">æˆç†ŸæœŸ / é—œä¿‚èˆ‡å€«ç†</div>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-3 text-center">
                    âš ï¸ æœ¬ç³»çµ±åƒ…æœå‹™18æ­²ä»¥ä¸‹é’å°‘å¹´
                </p>
            </div>

            <!-- Gender Selection -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-700 mb-4">ğŸ‘¤ è«‹é¸æ“‡æ‚¨çš„æ€§åˆ¥ï¼š</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="selectGender('male')" id="gender-male" class="gender-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-blue-50 to-cyan-50 hover:from-blue-100 hover:to-cyan-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">ğŸ‘¦</div>
                        ç”·
                    </button>
                    <button onclick="selectGender('female')" id="gender-female" class="gender-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-pink-50 to-rose-50 hover:from-pink-100 hover:to-rose-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">ğŸ‘§</div>
                        å¥³
                    </button>
                    <button onclick="selectGender('other')" id="gender-other" class="gender-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-purple-50 to-indigo-50 hover:from-purple-100 hover:to-indigo-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">ğŸŒˆ</div>
                        å…¶ä»–
                    </button>
                    <button onclick="selectGender('prefer-not-to-say')" id="gender-prefer-not-to-say" class="gender-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">ğŸ¤</div>
                        ä¸é¡˜é€éœ²
                    </button>
                </div>
            </div>

            <!-- Confirmation Button -->
            <div class="text-center pt-4">
                <button onclick="confirmUserInfo()" id="confirm-btn" disabled class="px-10 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-full text-lg transition-all duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 active:scale-95">
                    é–‹å§‹ä½¿ç”¨ ğŸš€
                </button>
                <p id="selection-hint" class="text-sm text-gray-500 mt-4">è«‹å…ˆé¸æ“‡å¹´é½¡æ®µå’Œæ€§åˆ¥</p>
            </div>
        </div>
    </div>

    <!-- Modern App (Hidden Initially) -->
    <div id="modern-app" class="hidden w-full h-screen flex flex-col overflow-hidden bg-white">
        
        <!-- Header (ç‹€æ…‹æ¬„) -->
        <header id="header-bar" class="p-4 md:p-5 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 flex justify-between items-center text-white shadow-lg">
            <div class="flex items-center space-x-2">
                <span id="ai-status" class="hidden sm:inline-block text-xs sm:text-sm font-semibold bg-white/20 px-2 sm:px-3 py-1 rounded-full backdrop-blur-sm">âœ¨ å·²é€£ç·š</span>
                <button id="theme-toggle-btn" 
                        onclick="toggleTheme()"
                        class="px-2 sm:px-3 py-1 bg-white/20 hover:bg-white/30 text-sm font-semibold rounded-full transition duration-200 active:scale-95 backdrop-blur-sm"
                        title="åˆ‡æ›ä¸»é¡Œ">
                    <span id="theme-icon">â˜€ï¸</span>
                </button>
            </div>
            <div class="text-lg sm:text-xl md:text-2xl font-bold" id="mode-display">
                ğŸ’ IntiMate æ„›å¿ƒå¯†èª
            </div>
            <div class="flex items-center space-x-2">
                <button id="post-test-btn" 
                        onclick="startPostTest()"
                        class="hidden px-3 sm:px-4 py-2 bg-green-500/90 hover:bg-green-600 text-white text-xs sm:text-sm font-semibold rounded-full transition duration-200 active:scale-95 shadow-lg hover:shadow-xl"
                        title="æª¢è¦–å­¸ç¿’æˆæ•ˆ">
                    ğŸ“ˆ æˆæ•ˆæ¸¬é©—
                </button>
                <button id="mode-toggle-btn" 
                        onclick="toggleMode()"
                        class="px-3 sm:px-4 py-2 bg-white/90 hover:bg-white text-purple-600 text-xs sm:text-sm font-semibold rounded-full transition duration-200 active:scale-95 shadow-lg hover:shadow-xl">
                    ğŸ¯ çŸ¥è­˜æ¸¬é©—
                </button>
            </div>
        </header>

        <!-- ä¸»å…§å®¹å€ -->
        <main class="flex-grow p-4 md:p-6 overflow-y-auto hide-scrollbar relative bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
            
            <!-- Chat Mode -->
            <div id="chat-mode-view" class="max-w-4xl mx-auto w-full space-y-4">
                <div id="messages-container" class="space-y-4 pb-4">
                    <!-- æ­¡è¿è¨Šæ¯å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- Quiz Mode -->
            <div id="quiz-mode-view" class="hidden flex flex-col items-center justify-center min-h-full p-4">
                <div class="w-full max-w-2xl bg-white p-6 md:p-8 rounded-3xl shadow-2xl border-4 border-purple-300">
                    <h2 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6 pb-3 border-b-2 border-purple-200">ğŸ¯ æ€§æ•™è‚²çŸ¥è­˜æ¸¬é©—</h2>
                    <div id="quiz-content" class="text-gray-800">
                        <p class="text-base md:text-lg font-medium text-center">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æ¸¬é©—ï¼ğŸš€</p>
                    </div>
                </div>
            </div>
            
            <!-- Post-Test Mode -->
            <div id="post-test-view" class="hidden flex flex-col items-center justify-center min-h-full p-4">
                <div class="w-full max-w-3xl bg-white p-6 md:p-8 rounded-3xl shadow-2xl border-4 border-green-300">
                    <h2 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent mb-6 pb-3 border-b-2 border-green-200">ğŸ“ˆ å­¸ç¿’æˆæ•ˆæ¸¬é©—</h2>
                    <div id="post-test-content" class="text-gray-800">
                        <!-- Post-test questions will be dynamically generated -->
                    </div>
                </div>
            </div>

        </main>

        <!-- è¼¸å…¥å€ -->
        <footer id="input-area" class="bg-white p-4 md:p-5 border-t-2 border-purple-200">
            <div id="chat-input-container" class="max-w-4xl mx-auto w-full flex flex-col space-y-3">
                <div class="flex space-x-2 sm:space-x-3">
                    <input type="text" id="user-input" placeholder="ğŸ’­ è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                           class="flex-grow p-3 sm:p-4 text-sm sm:text-base bg-gradient-to-r from-purple-100 to-pink-100 text-gray-800 border-2 border-purple-300 rounded-full focus:outline-none focus:ring-4 focus:ring-purple-300 placeholder-purple-400 transition duration-200 font-medium">
                    <button id="send-btn" onclick="sendMessage()"
                            class="px-4 sm:px-8 py-3 sm:py-4 text-sm sm:text-base bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold rounded-full transition duration-200 active:scale-95 shadow-lg hover:shadow-xl whitespace-nowrap">
                        ğŸš€ ç™¼é€
                    </button>
                </div>
                
                <!-- Disclaimer -->
                <div class="bg-amber-50 border-l-4 border-amber-400 p-2 sm:p-3 rounded-lg">
                    <div class="flex items-start">
                        <span class="text-amber-600 text-base sm:text-lg mr-2 flex-shrink-0">âš ï¸</span>
                        <p class="text-xs leading-relaxed text-amber-800">
                            <span class="font-bold">å…è²¬è²æ˜ï¼š</span>æœ¬ç³»çµ±æä¾›çš„è³‡è¨Šåƒ…ä¾›æ•™è‚²åƒè€ƒï¼Œ<span class="font-semibold">ä¸æ§‹æˆé†«å­¸å»ºè­°ã€è¨ºæ–·æˆ–æ²»ç™‚</span>ã€‚å¦‚æœ‰å¥åº·ç–‘æ…®æˆ–éœ€è¦å°ˆæ¥­å”åŠ©ï¼Œè«‹è«®è©¢åˆæ ¼çš„é†«è­·äººå“¡ã€å­¸æ ¡è¼”å°è€å¸«æˆ–æ’¥æ‰“ç›¸é—œè«®è©¢å°ˆç·šã€‚
                        </p>
                    </div>
                </div>
            </div>
            <div id="quiz-prompt" class="hidden text-center text-purple-600 py-2 font-medium">
                ğŸ“ è«‹åœ¨æ¸¬é©—å€å¡Šå®Œæˆä½œç­”ã€‚
            </div>
        </footer>

    </div><!-- End of modern-app -->

    <script>
        // --- User Profile Storage ---
        let userAge = null;
        let userGender = null;
        
        // --- Test Data Storage ---
        let preTestResults = {
            score: 0,
            total: 0,
            wrongTopics: [], // Topics user got wrong
            answers: [] // User's answers
        };
        
        let postTestResults = {
            score: 0,
            total: 0,
            answers: []
        };
        
        let hasCompletedPreTest = false;
        
        // --- Pre-Test Questions (Assessment Quiz) ---
        const preTestQuestions = [
            {
                id: 1,
                topic: 'é’æ˜¥æœŸç”Ÿç†è®ŠåŒ–',
                question: 'é’æ˜¥æœŸé–‹å§‹çš„ä¸»è¦æ¨™èªŒæ˜¯ä»€éº¼ï¼Ÿ',
                options: [
                    'èº«é«˜çªç„¶å¢é•·',
                    'ç¬¬äºŒæ€§å¾µé–‹å§‹å‡ºç¾',
                    'é–‹å§‹ä¸Šä¸­å­¸',
                    'å–œæ­¡èˆ‡ç•°æ€§äº¤å¾€'
                ],
                correctAnswer: 1,
                explanation: 'é’æ˜¥æœŸçš„ä¸»è¦æ¨™èªŒæ˜¯ç¬¬äºŒæ€§å¾µçš„å‡ºç¾ï¼ŒåŒ…æ‹¬æ€§å™¨å®˜ç™¼è‚²ã€é«”æ¯›ç”Ÿé•·ç­‰ã€‚'
            },
            {
                id: 2,
                topic: 'åŒæ„æ¬Š',
                question: 'é—œæ–¼ã€ŒåŒæ„æ¬Šã€ï¼Œä»¥ä¸‹å“ªå€‹èªªæ³•æ˜¯æ­£ç¢ºçš„ï¼Ÿ',
                options: [
                    'ä¸€æ—¦åŒæ„å°±ä¸èƒ½æ”¹è®Šä¸»æ„',
                    'æ²‰é»˜ä»£è¡¨åŒæ„',
                    'åŒæ„å¿…é ˆæ˜¯è‡ªé¡˜ã€æ¸…æ™°ä¸”å¯ä»¥éš¨æ™‚æ’¤å›çš„',
                    'åªè¦å°æ–¹æ˜¯æˆ€äººå°±ä¸éœ€è¦æ¯æ¬¡éƒ½å•'
                ],
                correctAnswer: 2,
                explanation: 'åŒæ„æ¬Šå¿…é ˆæ˜¯è‡ªé¡˜çµ¦äºˆçš„ã€æ¸…æ™°æ˜ç¢ºçš„ï¼Œä¸¦ä¸”å¯ä»¥éš¨æ™‚æ’¤å›ã€‚'
            },
            {
                id: 3,
                topic: 'ç¶²è·¯å®‰å…¨',
                question: 'ä»¥ä¸‹å“ªç¨®è¡Œç‚ºåœ¨ç¶²è·¯ä¸Šæœ€å®‰å…¨ï¼Ÿ',
                options: [
                    'èˆ‡ç¶²å‹åˆ†äº«è‡ªå·±çš„ç§å¯†ç…§ç‰‡',
                    'åœ¨ç¤¾äº¤åª’é«”ä¸Šå…¬é–‹å€‹äººè©³ç´°è³‡è¨Š',
                    'ä¿è­·å€‹äººéš±ç§ï¼Œä¸è¼•æ˜“åˆ†äº«æ•æ„Ÿè³‡è¨Š',
                    'èˆ‡é™Œç”Ÿç¶²å‹ç´„è¦‹é¢'
                ],
                correctAnswer: 2,
                explanation: 'ä¿è­·å€‹äººéš±ç§å’Œæ•æ„Ÿè³‡è¨Šæ˜¯ç¶²è·¯å®‰å…¨çš„é—œéµã€‚ä¸€æ—¦è³‡æ–™å¤–æµï¼Œå¾ˆé›£æ”¶å›ã€‚'
            },
            {
                id: 4,
                topic: 'æ€§å‚³æŸ“ç—…é é˜²',
                question: 'ä»¥ä¸‹å“ªé …ä¸æ˜¯é é˜²æ€§å‚³æŸ“ç—…ï¼ˆSTIï¼‰çš„æœ‰æ•ˆæ–¹æ³•ï¼Ÿ',
                options: [
                    'æ­£ç¢ºä½¿ç”¨ä¿éšªå¥—',
                    'å®šæœŸé€²è¡Œå¥åº·æª¢æŸ¥',
                    'é¿å…èˆ‡å¤šäººç™¼ç”Ÿæ€§è¡Œç‚º',
                    'åªå’Œçœ‹èµ·ä¾†å¥åº·çš„äººç™¼ç”Ÿé—œä¿‚'
                ],
                correctAnswer: 3,
                explanation: 'å¤–è¡¨ç„¡æ³•åˆ¤æ–·æ˜¯å¦æœ‰STIã€‚é é˜²éœ€è¦æ­£ç¢ºä½¿ç”¨ä¿éšªå¥—ã€å®šæœŸæª¢æŸ¥ç­‰ç§‘å­¸æ–¹æ³•ã€‚'
            },
            {
                id: 5,
                topic: 'èº«é«”è‡ªä¸»æ¬Š',
                question: 'å¦‚æœæœ‰äººè®“ä½ æ„Ÿåˆ°ä¸èˆ’æœæˆ–ä¸å°Šé‡ä½ çš„èº«é«”ç•Œç·šï¼Œä½ æ‡‰è©²ï¼Ÿ',
                options: [
                    'å¿è€ä¸èªªï¼Œæ€•ç ´å£é—œä¿‚',
                    'æ˜ç¢ºè¡¨é”æ‹’çµ•ï¼Œä¸¦å°‹æ±‚ä¿¡ä»»çš„æˆäººå”åŠ©',
                    'è¦ºå¾—æ˜¯è‡ªå·±çš„å•é¡Œ',
                    'åœ¨ç¤¾äº¤åª’é«”ä¸Šç™¼æ´©'
                ],
                correctAnswer: 1,
                explanation: 'ä½ æœ‰æ¬Šåˆ©ä¿è­·è‡ªå·±çš„èº«é«”ç•Œç·šã€‚æ˜ç¢ºæ‹’çµ•ä¸¦å°‹æ±‚å¹«åŠ©æ˜¯æœ€æ­£ç¢ºçš„åšæ³•ã€‚'
            },
            {
                id: 6,
                topic: 'å¥åº·é—œä¿‚',
                question: 'å¥åº·çš„æˆ€æ„›é—œä¿‚æ‡‰è©²åŒ…æ‹¬ä»¥ä¸‹å“ªé …ï¼Ÿ',
                options: [
                    'å…¶ä¸­ä¸€æ–¹å®Œå…¨è½å¾å¦ä¸€æ–¹',
                    'äº’ç›¸å°Šé‡ã€ä¿¡ä»»å’Œæºé€š',
                    'æ™‚å¸¸æª¢æŸ¥å°æ–¹æ‰‹æ©Ÿç¢ºä¿å¿ èª ',
                    'ç‚ºäº†å°æ–¹æ”¾æ£„æ‰€æœ‰æœ‹å‹'
                ],
                correctAnswer: 1,
                explanation: 'å¥åº·çš„é—œä¿‚å»ºç«‹åœ¨äº’ç›¸å°Šé‡ã€ä¿¡ä»»å’Œè‰¯å¥½æºé€šçš„åŸºç¤ä¸Šã€‚'
            }
        ];
        
        // --- Theme Management ---
        let currentTheme = localStorage.getItem('theme') || 'bright';
        
        // Initialize theme on page load
        function initTheme() {
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                updateThemeIcon();
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            if (currentTheme === 'bright') {
                currentTheme = 'dark';
                document.body.classList.add('dark-mode');
            } else {
                currentTheme = 'bright';
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
        }
        
        // Update theme icon
        function updateThemeIcon() {
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = currentTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
            }
        }
        
        // Call initTheme when page loads
        initTheme();

        // --- Page Transition Logic ---
        function startSystem() {
            const oldSchoolPage = document.getElementById('old-school-page');
            const loadingPage = document.getElementById('loading-page');
            const userInfoPage = document.getElementById('user-info-page');
            const loadingContent = document.getElementById('loading-content');
            const transitionContent = document.getElementById('transition-content');
            const upgradeText = document.getElementById('upgrade-text');
            const cursor = document.getElementById('cursor');
            
            // Fade out old school page
            oldSchoolPage.classList.add('fade-out');
            
            setTimeout(() => {
                oldSchoolPage.classList.add('hidden');
                loadingPage.classList.remove('hidden');
                loadingPage.classList.add('fade-in');
                
                // Simulate loading progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 25;
                    if (progress > 100) progress = 100;
                    document.getElementById('progress').textContent = Math.floor(progress);
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        
                        // Hide cursor and fade out loading content
                        cursor.style.display = 'none';
                        
                        setTimeout(() => {
                            loadingContent.classList.add('fade-out');
                            
                            setTimeout(() => {
                                loadingContent.style.display = 'none';
                                transitionContent.style.display = 'block';
                                
                                // Show the joke text
                                setTimeout(() => {
                                    // Start background morphing
                                    loadingPage.classList.add('morphing-bg');
                                    
                                    // Show upgrade text after joke
                                    setTimeout(() => {
                                        upgradeText.style.display = 'block';
                                        
                                        // Wait for animations to complete
                                        setTimeout(() => {
                                            // Transition to user info page
                                            loadingPage.classList.add('fade-out');
                                            
                                            setTimeout(() => {
                                                loadingPage.classList.add('hidden');
                                                userInfoPage.classList.remove('hidden');
                                                userInfoPage.classList.add('scale-up');
                                            }, 800);
                                        }, 4000); // Wait for morphing animations
                                    }, 1500); // Delay before showing upgrade text
                                }, 300);
                            }, 500);
                        }, 500);
                    }
                }, 150);
            }, 500);
        }

        // --- User Info Collection Logic ---
        function selectAge(age) {
            userAge = age;
            
            // Visual feedback - highlight selected
            document.querySelectorAll('.age-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-purple-500', 'bg-gradient-to-br', 'from-purple-200', 'to-pink-200');
                btn.classList.add('bg-gradient-to-br', 'from-purple-50', 'to-pink-50');
            });
            document.getElementById(`age-${age}`).classList.remove('from-purple-50', 'to-pink-50');
            document.getElementById(`age-${age}`).classList.add('from-purple-200', 'to-pink-200', 'ring-4', 'ring-purple-500');
            
            checkUserInfoComplete();
        }

        function selectGender(gender) {
            userGender = gender;
            
            // Visual feedback - highlight selected
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-purple-500');
            });
            document.getElementById(`gender-${gender}`).classList.add('ring-4', 'ring-purple-500');
            
            checkUserInfoComplete();
        }

        function checkUserInfoComplete() {
            const confirmBtn = document.getElementById('confirm-btn');
            const hint = document.getElementById('selection-hint');
            
            if (userAge && userGender) {
                confirmBtn.disabled = false;
                hint.textContent = 'âœ… è³‡æ–™å®Œæ•´ï¼å¯ä»¥é–‹å§‹ä½¿ç”¨äº†';
                hint.classList.remove('text-gray-500');
                hint.classList.add('text-green-600', 'font-semibold');
            }
        }

        function confirmUserInfo() {
            const userInfoPage = document.getElementById('user-info-page');
            const preTestPage = document.getElementById('pre-test-page');
            
            userInfoPage.classList.add('fade-out');
            
            setTimeout(() => {
                userInfoPage.classList.add('hidden');
                preTestPage.classList.remove('hidden');
                preTestPage.classList.add('scale-up');
                
                // é–‹å§‹ Pre-Test
                startPreTest();
            }, 500);
        }
        
        // --- Pre-Test Functions ---
        let currentPreTestQuestion = 0;
        
        function startPreTest() {
            currentPreTestQuestion = 0;
            preTestResults = {
                score: 0,
                total: preTestQuestions.length,
                wrongTopics: [],
                answers: []
            };
            renderPreTestQuestion();
        }
        
        function renderPreTestQuestion() {
            const content = document.getElementById('pre-test-content');
            
            if (currentPreTestQuestion >= preTestQuestions.length) {
                // æ¸¬é©—å®Œæˆ
                completePreTest();
                return;
            }
            
            const q = preTestQuestions[currentPreTestQuestion];
            const progress = ((currentPreTestQuestion / preTestQuestions.length) * 100).toFixed(0);
            
            content.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-purple-600">é¡Œç›® ${currentPreTestQuestion + 1} / ${preTestQuestions.length}</span>
                        <span class="text-sm text-gray-500">${progress}%</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 md:p-6 rounded-2xl mb-4">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 mb-4">${q.question}</h3>
                    <div class="space-y-3">
                        ${q.options.map((option, index) => `
                            <button onclick="answerPreTest(${index})" 
                                    class="w-full p-4 text-left rounded-xl transition-all bg-white hover:bg-purple-100 border-2 border-purple-200 hover:border-purple-400 text-gray-700 hover:text-gray-900 font-medium text-sm md:text-base">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function answerPreTest(selectedIndex) {
            const q = preTestQuestions[currentPreTestQuestion];
            const isCorrect = selectedIndex === q.correctAnswer;
            
            // è¨˜éŒ„ç­”æ¡ˆ
            preTestResults.answers.push({
                questionId: q.id,
                topic: q.topic,
                correct: isCorrect,
                selectedAnswer: selectedIndex
            });
            
            if (isCorrect) {
                preTestResults.score++;
            } else {
                // è¨˜éŒ„ç­”éŒ¯çš„ä¸»é¡Œ
                if (!preTestResults.wrongTopics.includes(q.topic)) {
                    preTestResults.wrongTopics.push(q.topic);
                }
            }
            
            // ä¸‹ä¸€é¡Œ
            currentPreTestQuestion++;
            renderPreTestQuestion();
        }
        
        function completePreTest() {
            const content = document.getElementById('pre-test-content');
            const result = document.getElementById('pre-test-result');
            
            content.classList.add('hidden');
            result.classList.remove('hidden');
            
            hasCompletedPreTest = true;
            
            // 2ç§’å¾Œé€²å…¥ä¸»æ‡‰ç”¨
            setTimeout(() => {
                const preTestPage = document.getElementById('pre-test-page');
                const modernApp = document.getElementById('modern-app');
                
                preTestPage.classList.add('fade-out');
                
                setTimeout(() => {
                    preTestPage.classList.add('hidden');
                    modernApp.classList.remove('hidden');
                    modernApp.classList.add('scale-up');
                    
                    // é¡¯ç¤ºå€‹æ€§åŒ–æ­¡è¿è¨Šæ¯ï¼ˆåŒ…å«æ¸¬é©—çµæœåˆ†æï¼‰
                    showWelcomeMessageWithPreTestAnalysis();
                    
                    // é¡¯ç¤º Post-Test æŒ‰éˆ•
                    document.getElementById('post-test-btn').classList.remove('hidden');
                    
                    // æ›´æ–°ä¸»é¡Œåœ–æ¨™
                    updateThemeIcon();
                }, 500);
            }, 2000);
        }

        // ç”Ÿæˆä¸¦é¡¯ç¤ºå¸¶æœ‰ Pre-Test åˆ†æçš„æ­¡è¿è¨Šæ¯
        function showWelcomeMessageWithPreTestAnalysis() {
            const container = document.getElementById('messages-container');
            const scorePercent = Math.round((preTestResults.score / preTestResults.total) * 100);
            
            let greeting = '';
            let performanceMsg = '';
            
            // æ ¹æ“šå¹´é½¡æ®µå®šåˆ¶æ­¡è¿èª
            switch(userAge) {
                case '10-13':
                    greeting = 'å—¨ï¼å¾ˆé«˜èˆˆèªè­˜ä½ ï¼ğŸ‘‹';
                    break;
                case '13-15':
                    greeting = 'å—¨ï¼æ­¡è¿ä¾†åˆ° IntiMateï¼ğŸ˜Š';
                    break;
                case '16-18':
                    greeting = 'ä½ å¥½ï¼æ­¡è¿ä½¿ç”¨ IntiMateï¼ğŸ‘‹';
                    break;
            }
            
            // æ ¹æ“šåˆ†æ•¸çµ¦äºˆè©•åƒ¹
            if (scorePercent >= 80) {
                performanceMsg = 'ä½ å°æ€§æ•™è‚²çŸ¥è­˜æœ‰å¾ˆå¥½çš„ç†è§£ï¼ğŸ‘';
            } else if (scorePercent >= 60) {
                performanceMsg = 'ä½ æœ‰ä¸€å®šçš„åŸºç¤çŸ¥è­˜ï¼Œæˆ‘æœƒå¹«åŠ©ä½ é€²ä¸€æ­¥æå‡ï¼ğŸ’ª';
            } else {
                performanceMsg = 'åˆ¥æ“”å¿ƒï¼æˆ‘æœƒç”¨å¿ƒæŒ‡å°ä½ ï¼Œå¹«åŠ©ä½ å»ºç«‹æ­£ç¢ºçš„çŸ¥è­˜ã€‚âœ¨';
            }
            
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'flex justify-start message-slide-in';
            welcomeMessage.innerHTML = `
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                    <p class="text-sm font-bold mb-2 flex items-center">ğŸ’ IntiMate æ„›å¿ƒå¯†èª</p>
                    <p class="text-lg font-semibold mb-2">${greeting}</p>
                    <p class="leading-relaxed mb-3">æˆ‘æ˜¯ IntiMate æ„›å¿ƒå¯†èªï¼Œä½ çš„è²¼å¿ƒè¼”å°å¤¥ä¼´ã€‚</p>
                    <div class="bg-white/20 p-3 rounded-xl mb-2">
                        <p class="font-semibold mb-1">ğŸ“Š ä½ çš„è©•ä¼°çµæœï¼š</p>
                        <p class="text-sm">ç­”å° ${preTestResults.score} / ${preTestResults.total} é¡Œ (${scorePercent}%)</p>
                        <p class="text-sm mt-1">${performanceMsg}</p>
                    </div>
                </div>
            `;
            container.appendChild(welcomeMessage);
            
            // å»¶é²é¡¯ç¤ºè©±é¡Œå»ºè­°
            setTimeout(() => {
                showTopicSuggestion();
            }, 800);
        }
        
        // é¡¯ç¤ºè©±é¡Œå»ºè­°
        function showTopicSuggestion() {
            const container = document.getElementById('messages-container');
            
            let suggestionText = '';
            let suggestedTopic = '';
            
            if (preTestResults.wrongTopics.length > 0) {
                // æœ‰ç­”éŒ¯çš„é¡Œç›®ï¼Œå»ºè­°å¾å¼±é»é–‹å§‹
                suggestedTopic = preTestResults.wrongTopics[0];
                suggestionText = `æˆ‘æ³¨æ„åˆ°ä½ åœ¨ã€Œ<span class="font-bold">${suggestedTopic}</span>ã€é€™å€‹ä¸»é¡Œå¯èƒ½éœ€è¦å¤šäº†è§£ä¸€äº›ã€‚`;
            } else {
                // å…¨å°ï¼Œå»ºè­°ä¸€å€‹é©åˆçš„ä¸»é¡Œ
                const topics = getRecommendedTopics();
                suggestedTopic = topics[0];
                suggestionText = `ä½ çš„åŸºç¤å¾ˆå¥½ï¼æˆ‘å»ºè­°æˆ‘å€‘å¯ä»¥èŠèŠã€Œ<span class="font-bold">${suggestedTopic}</span>ã€ã€‚`;
            }
            
            const suggestionMessage = document.createElement('div');
            suggestionMessage.className = 'flex justify-start message-slide-in';
            suggestionMessage.innerHTML = `
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                    <p class="text-sm font-bold mb-2 flex items-center">ğŸ’ IntiMate æ„›å¿ƒå¯†èª</p>
                    <p class="leading-relaxed mb-3">${suggestionText}</p>
                    <p class="text-sm mb-3">ä½ æƒ³å¾é€™å€‹è©±é¡Œé–‹å§‹è¨è«–å—ï¼Ÿ</p>
                    <div class="flex space-x-2">
                        <button onclick="acceptTopicSuggestion('${suggestedTopic}')" 
                                class="flex-1 px-4 py-2 bg-white/90 hover:bg-white text-purple-600 font-semibold rounded-full transition duration-200 active:scale-95">
                            âœ“ å¥½çš„ï¼Œé–‹å§‹å§
                        </button>
                        <button onclick="showTopicOptions()" 
                                class="flex-1 px-4 py-2 bg-white/20 hover:bg-white/30 text-white font-semibold rounded-full transition duration-200 active:scale-95">
                            âœ— æˆ‘æƒ³é¸å…¶ä»–è©±é¡Œ
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(suggestionMessage);
            container.scrollTop = container.scrollHeight;
        }
        
        // ç²å–æ¨è–¦è©±é¡Œåˆ—è¡¨ï¼ˆæ ¹æ“šå¹´é½¡å’Œæ€§åˆ¥ï¼‰
        function getRecommendedTopics() {
            let topics = [];
            
            // æ ¹æ“šå¹´é½¡æ®µæ¨è–¦
            switch(userAge) {
                case '10-13':
                    topics = [
                        'é’æ˜¥æœŸèº«é«”è®ŠåŒ–',
                        'å€‹äººè¡›ç”Ÿèˆ‡æ¸…æ½”',
                        'æƒ…ç·’ç®¡ç†',
                        'ä¿è­·å€‹äººéš±ç§',
                        'èªè­˜å‹èª¼èˆ‡ç•Œç·š'
                    ];
                    break;
                case '13-15':
                    topics = [
                        'é’æ˜¥æœŸçš„æƒ…æ„Ÿè®ŠåŒ–',
                        'å¥åº·çš„äººéš›é—œä¿‚',
                        'ç¶²è·¯å®‰å…¨èˆ‡éš±ç§',
                        'è‡ªæˆ‘ä¿è­·èˆ‡æ‹’çµ•æŠ€å·§',
                        'èº«é«”è‡ªä¸»æ¬Š',
                        'æ€§åˆ¥èªåŒèˆ‡æ¢ç´¢'
                    ];
                    break;
                case '16-18':
                    topics = [
                        'è¦ªå¯†é—œä¿‚èˆ‡åŒæ„æ¬Š',
                        'é¿å­•æ–¹æ³•èˆ‡æ€§å¥åº·',
                        'æ€§å‚³æŸ“ç—…é é˜²',
                        'å¥åº·çš„æˆ€æ„›é—œä¿‚',
                        'æ€§åˆ¥å¹³ç­‰èˆ‡å°Šé‡',
                        'å¿ƒç†å¥åº·èˆ‡å£“åŠ›'
                    ];
                    break;
            }
            
            // æ ¹æ“šæ€§åˆ¥å¾®èª¿ï¼ˆæ·»åŠ ç‰¹å®šè©±é¡Œï¼‰
            if (userGender === 'male') {
                if (userAge === '10-13') topics.push('ç”·ç”Ÿçš„é’æ˜¥æœŸè®ŠåŒ–');
                if (userAge === '13-15') topics.push('è™•ç†é’æ˜¥æœŸå›°æ“¾');
                if (userAge === '16-18') topics.push('ç”·æ€§å¥åº·èˆ‡è²¬ä»»');
            } else if (userGender === 'female') {
                if (userAge === '10-13') topics.push('å¥³ç”Ÿçš„é’æ˜¥æœŸè®ŠåŒ–');
                if (userAge === '13-15') topics.push('æœˆç¶“èˆ‡ç¶“æœŸä¿å¥');
                if (userAge === '16-18') topics.push('å¥³æ€§å¥åº·èˆ‡å®‰å…¨');
            }
            
            return topics;
        }
        
        // æ¥å—è©±é¡Œå»ºè­°
        function acceptTopicSuggestion(topic) {
            // é¡¯ç¤ºç”¨æˆ¶é¸æ“‡
            renderUserMessage(`å¥½çš„ï¼Œæˆ‘æƒ³äº†è§£ã€Œ${topic}ã€`);
            
            // é–å®šè¼¸å…¥
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            input.disabled = true;
            sendBtn.disabled = true;
            
            // AI é–‹å§‹å¼•å°å¼è¨è«–
            startGuidedDiscussion(topic);
        }
        
        // é¡¯ç¤ºè©±é¡Œé¸é …
        function showTopicOptions() {
            const container = document.getElementById('messages-container');
            
            // é¡¯ç¤ºç”¨æˆ¶é¸æ“‡
            renderUserMessage('æˆ‘æƒ³é¸å…¶ä»–è©±é¡Œ');
            
            const topics = getRecommendedTopics();
            
            setTimeout(() => {
                const optionsMessage = document.createElement('div');
                optionsMessage.className = 'flex justify-start message-slide-in';
                optionsMessage.innerHTML = `
                    <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                        <p class="text-sm font-bold mb-2 flex items-center">ğŸ’ IntiMate æ„›å¿ƒå¯†èª</p>
                        <p class="leading-relaxed mb-3">æ²’å•é¡Œï¼ä»¥ä¸‹æ˜¯ä¸€äº›é©åˆä½ çš„è©±é¡Œï¼Œé¸ä¸€å€‹ä½ æœ€æƒ³äº†è§£çš„ï¼š</p>
                        <div class="space-y-2">
                            ${topics.slice(0, 5).map((topic, index) => `
                                <button onclick="selectTopic('${topic}')" 
                                        class="w-full px-4 py-3 bg-white/90 hover:bg-white text-purple-600 text-left font-medium rounded-xl transition duration-200 active:scale-95 flex items-center">
                                    <span class="mr-2">${index + 1}.</span>
                                    <span>${topic}</span>
                                </button>
                            `).join('')}
                            <button onclick="enableFreeChat()" 
                                    class="w-full px-4 py-3 bg-white/20 hover:bg-white/30 text-white text-left font-medium rounded-xl transition duration-200 active:scale-95 flex items-center">
                                <span class="mr-2">ğŸ’¬</span>
                                <span>æˆ‘æƒ³è‡ªå·±æå•</span>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(optionsMessage);
                container.scrollTop = container.scrollHeight;
            }, 500);
        }
        
        // é¸æ“‡è©±é¡Œ
        function selectTopic(topic) {
            renderUserMessage(`æˆ‘æƒ³äº†è§£ã€Œ${topic}ã€`);
            
            // é–å®šè¼¸å…¥
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            input.disabled = true;
            sendBtn.disabled = true;
            
            startGuidedDiscussion(topic);
        }
        
        // é–‹å§‹å¼•å°å¼è¨è«–
        async function startGuidedDiscussion(topic) {
            // æ§‹å»ºå¼•å°å¼å°è©±çš„ prompt
            const guidedPrompt = `æˆ‘æƒ³æ·±å…¥äº†è§£ã€Œ${topic}ã€é€™å€‹ä¸»é¡Œã€‚è«‹ç”¨å¼•å°å¼çš„æ–¹å¼å’Œæˆ‘è¨è«–ï¼Œå°±åƒä¸€ä½çœŸäººè¼”å°å“¡ä¸€æ¨£ï¼š
1. å…ˆå¾åŸºç¤æ¦‚å¿µé–‹å§‹ï¼Œç”¨ç°¡å–®çš„æ–¹å¼è§£é‡‹
2. å•æˆ‘æ˜¯å¦æœ‰ç›¸é—œçš„ç–‘å•æˆ–å›°æƒ‘
3. æ ¹æ“šæˆ‘çš„å›æ‡‰ç¹¼çºŒæ·±å…¥
4. é©æ™‚çµ¦äºˆå¯¦ç”¨çš„å»ºè­°å’Œä¾‹å­

è«‹ç¾åœ¨é–‹å§‹ç¬¬ä¸€æ­¥ï¼Œç”¨æº«æš–å‹å–„çš„æ–¹å¼ä»‹ç´¹é€™å€‹ä¸»é¡Œã€‚`;
            
            await streamAIResponse(guidedPrompt);
            
            // è§£é–è¼¸å…¥ï¼Œè®“ç”¨æˆ¶å¯ä»¥ç¹¼çºŒå°è©±
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
        
        // å•Ÿç”¨è‡ªç”±å°è©±
        function enableFreeChat() {
            const container = document.getElementById('messages-container');
            
            renderUserMessage('æˆ‘æƒ³è‡ªå·±æå•');
            
            setTimeout(() => {
                const freeMessage = document.createElement('div');
                freeMessage.className = 'flex justify-start message-slide-in';
                freeMessage.innerHTML = `
                    <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                        <p class="text-sm font-bold mb-2 flex items-center">ğŸ’ IntiMate æ„›å¿ƒå¯†èª</p>
                        <p class="leading-relaxed">å¤ªå¥½äº†ï¼ä½ å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼æ€§æ•™è‚²çš„å•é¡Œï¼Œæˆ‘æœƒç”¨å¿ƒå›ç­”ä½ ã€‚åˆ¥æ“”å¿ƒï¼Œé€™æ˜¯å€‹å®‰å…¨çš„ç©ºé–“ï¼Œæ²’æœ‰æ„šè ¢çš„å•é¡Œã€‚ğŸ’­</p>
                    </div>
                `;
                container.appendChild(freeMessage);
                container.scrollTop = container.scrollHeight;
            }, 500);
            
            // ç¢ºä¿è¼¸å…¥æ¡†å¯ç”¨
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
        
        // --- Post-Test Functions ---
        let currentPostTestQuestion = 0;
        
        function startPostTest() {
            // åˆ‡æ›åˆ° post-test è¦–åœ–
            document.getElementById('chat-mode-view').classList.add('hidden');
            document.getElementById('quiz-mode-view').classList.add('hidden');
            document.getElementById('post-test-view').classList.remove('hidden');
            document.getElementById('chat-input-container').classList.add('hidden');
            
            currentPostTestQuestion = 0;
            postTestResults = {
                score: 0,
                total: preTestQuestions.length,
                answers: []
            };
            
            renderPostTestQuestion();
        }
        
        function renderPostTestQuestion() {
            const content = document.getElementById('post-test-content');
            
            if (currentPostTestQuestion >= preTestQuestions.length) {
                // Post-test å®Œæˆ
                showPostTestResults();
                return;
            }
            
            const q = preTestQuestions[currentPostTestQuestion];
            const progress = ((currentPostTestQuestion / preTestQuestions.length) * 100).toFixed(0);
            
            content.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-green-600">é¡Œç›® ${currentPostTestQuestion + 1} / ${preTestQuestions.length}</span>
                        <span class="text-sm text-gray-500">${progress}%</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 md:p-6 rounded-2xl mb-4">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 mb-4">${q.question}</h3>
                    <div class="space-y-3">
                        ${q.options.map((option, index) => `
                            <button onclick="answerPostTest(${index})" 
                                    class="w-full p-4 text-left rounded-xl transition-all bg-white hover:bg-green-100 border-2 border-green-200 hover:border-green-400 text-gray-700 hover:text-gray-900 font-medium text-sm md:text-base">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function answerPostTest(selectedIndex) {
            const q = preTestQuestions[currentPostTestQuestion];
            const isCorrect = selectedIndex === q.correctAnswer;
            
            postTestResults.answers.push({
                questionId: q.id,
                topic: q.topic,
                correct: isCorrect,
                selectedAnswer: selectedIndex
            });
            
            if (isCorrect) {
                postTestResults.score++;
            }
            
            currentPostTestQuestion++;
            renderPostTestQuestion();
        }
        
        function showPostTestResults() {
            const content = document.getElementById('post-test-content');
            
            const preScore = preTestResults.score;
            const postScore = postTestResults.score;
            const total = preTestResults.total;
            const improvement = postScore - preScore;
            const improvementPercent = ((improvement / total) * 100).toFixed(0);
            
            const prePercent = Math.round((preScore / total) * 100);
            const postPercent = Math.round((postScore / total) * 100);
            
            let message = '';
            let emoji = '';
            
            if (improvement > 0) {
                emoji = 'ğŸ‰';
                message = `å¤ªæ£’äº†ï¼ä½ é€²æ­¥äº† ${improvement} é¡Œï¼é€™è­‰æ˜ä½ åœ¨ä½¿ç”¨ IntiMate çš„éç¨‹ä¸­ç¢ºå¯¦å­¸åˆ°äº†æ–°çŸ¥è­˜ã€‚`;
            } else if (improvement === 0) {
                emoji = 'ğŸ‘';
                message = 'ä½ ä¿æŒäº†åŸæœ‰çš„æ°´å¹³ã€‚å¦‚æœé‚„æœ‰ä¸æ¸…æ¥šçš„åœ°æ–¹ï¼Œæ­¡è¿ç¹¼çºŒå‘æˆ‘æå•ï¼';
            } else {
                emoji = 'ğŸ’ª';
                message = 'åˆ¥æ°£é¤’ï¼å­¸ç¿’æ˜¯ä¸€å€‹æŒçºŒçš„éç¨‹ï¼Œæ­¡è¿éš¨æ™‚å›ä¾†è¤‡ç¿’å’Œæå•ã€‚';
            }
            
            content.innerHTML = `
                <div class="text-center space-y-6">
                    <div class="text-8xl mb-4">${emoji}</div>
                    <h3 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">
                        æ¸¬é©—å®Œæˆï¼
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                        <div class="bg-purple-100 p-4 rounded-2xl">
                            <p class="text-sm text-purple-600 font-semibold mb-1">åˆæ¸¬æˆç¸¾</p>
                            <p class="text-3xl font-bold text-purple-700">${prePercent}%</p>
                            <p class="text-xs text-gray-600">${preScore}/${total} é¡Œ</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-2xl">
                            <p class="text-sm text-green-600 font-semibold mb-1">ç¾åœ¨æˆç¸¾</p>
                            <p class="text-3xl font-bold text-green-700">${postPercent}%</p>
                            <p class="text-xs text-gray-600">${postScore}/${total} é¡Œ</p>
                        </div>
                    </div>
                    
                    ${improvement !== 0 ? `
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-2xl border-2 border-green-200">
                            <p class="text-2xl font-bold ${improvement > 0 ? 'text-green-600' : 'text-orange-600'}">
                                ${improvement > 0 ? '+' : ''}${improvementPercent}%
                            </p>
                            <p class="text-sm text-gray-600">é€²æ­¥å¹…åº¦</p>
                        </div>
                    ` : ''}
                    
                    <p class="text-base text-gray-700 leading-relaxed max-w-md mx-auto">${message}</p>
                    
                    <button onclick="returnToChat()" 
                            class="mt-6 px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold rounded-full transition duration-200 shadow-lg hover:shadow-xl active:scale-95">
                        ğŸ’¬ è¿”å›å°è©±
                    </button>
                </div>
            `;
        }
        
        function returnToChat() {
            document.getElementById('post-test-view').classList.add('hidden');
            document.getElementById('chat-mode-view').classList.remove('hidden');
            document.getElementById('chat-input-container').classList.remove('hidden');
        }
        
        // --- æ ¸å¿ƒé…ç½® ---
        let currentMode = 'chat'; 
        
        // é—œéµï¼šæŒ‡å‘ Vercel éƒ¨ç½²çš„ Serverless Function è·¯å¾‘
        // Vercel æœƒè‡ªå‹•å°‡ /api/chat æ˜ å°„åˆ°æ‚¨éƒ¨ç½²çš„ chat.js æª”æ¡ˆ
        const API_URL = '/api/chat'; 
        
        // å‹•æ…‹ç”Ÿæˆç³»çµ±æŒ‡ä»¤ï¼Œæ ¹æ“šä½¿ç”¨è€…çš„å¹´é½¡å’Œæ€§åˆ¥
        function getSystemInstruction() {
            let ageContext = '';
            let genderContext = '';
            
            // æ ¹æ“šå¹´é½¡æ®µèª¿æ•´èªæ°£å’Œå…§å®¹æ·±åº¦
            switch(userAge) {
                case '10-13':
                    ageContext = 'ä½ æ­£åœ¨èˆ‡ä¸€ä½10-13æ­²çš„é’å°‘å¹´å°è©±ï¼ˆæ¢ç´¢æœŸ / åŸºç¤èªçŸ¥éšæ®µï¼‰ã€‚è«‹ä½¿ç”¨æº«å’Œã€åŸºç¤ã€å…·é«”çš„èªè¨€ï¼Œé¿å…å°ˆæ¥­è¡“èªï¼Œé‡é»åœ¨æ–¼èº«é«”çš„åˆç´šè®ŠåŒ–ã€å€‹äººè¡›ç”Ÿèˆ‡éš±ç§ç•Œç·šã€‚å¼·èª¿å‘Šè¨´å®¶é•·æˆ–å¯ä¿¡ä»»çš„å¤§äººçš„é‡è¦æ€§ã€‚';
                    break;
                case '13-15':
                    ageContext = 'ä½ æ­£åœ¨èˆ‡ä¸€ä½13-15æ­²çš„é’å°‘å¹´å°è©±ï¼ˆéæ¸¡æœŸ / ç¤¾æœƒèªçŸ¥éšæ®µï¼‰ã€‚è«‹ä½¿ç”¨ä¸­ç«‹ã€å¯¦ç”¨çš„èªè¨€ï¼Œå°ˆæ³¨æ–¼äººéš›é—œä¿‚çš„å¥åº·äº’å‹•ã€ç¶²è·¯å®‰å…¨ã€ä»¥åŠæ€§è¡Œç‚ºå¾Œæœçš„åˆæ­¥èªçŸ¥ã€‚èªæ°£è¦å‹å–„ã€ä¸è©•åˆ¤ã€‚';
                    break;
                case '16-18':
                    ageContext = 'ä½ æ­£åœ¨èˆ‡ä¸€ä½16-18æ­²çš„é’å°‘å¹´å°è©±ï¼ˆæˆç†ŸæœŸ / é—œä¿‚èˆ‡å€«ç†éšæ®µï¼‰ã€‚è«‹ä½¿ç”¨æˆç†Ÿã€æ·±å…¥ã€å€«ç†çš„èªè¨€ï¼Œé‡é»åœ¨æ–¼åŒæ„æ¬Šçš„æ³•å¾‹èˆ‡å€«ç†è²¬ä»»ã€é¿å­•ã€STIé é˜²ï¼Œä»¥åŠå€‹äººèº«ä»½çš„æ·±å…¥æ¢ç´¢ã€‚';
                    break;
            }
            
            // æ ¹æ“šæ€§åˆ¥æä¾›æ›´ç›¸é—œçš„å»ºè­°
            switch(userGender) {
                case 'male':
                    genderContext = 'å°æ–¹è‡ªèªç‚ºç”·æ€§ã€‚åœ¨æä¾›å»ºè­°æ™‚ï¼Œå¯ä»¥ç‰¹åˆ¥é—œæ³¨ç”·æ€§ç”Ÿç†è®ŠåŒ–ã€å¿ƒç†å¥åº·ã€å°Šé‡ä»–äººç•Œç·šç­‰ä¸»é¡Œï¼Œä½†ä¿æŒå…§å®¹çš„åŒ…å®¹æ€§ã€‚';
                    break;
                case 'female':
                    genderContext = 'å°æ–¹è‡ªèªç‚ºå¥³æ€§ã€‚åœ¨æä¾›å»ºè­°æ™‚ï¼Œå¯ä»¥ç‰¹åˆ¥é—œæ³¨å¥³æ€§ç”Ÿç†è®ŠåŒ–ã€ç¶“æœŸå¥åº·ã€äººèº«å®‰å…¨ç­‰ä¸»é¡Œï¼Œä½†ä¿æŒå…§å®¹çš„åŒ…å®¹æ€§ã€‚';
                    break;
                case 'other':
                    genderContext = 'å°æ–¹è‡ªèªç‚ºå…¶ä»–æ€§åˆ¥èªåŒã€‚è«‹ç‰¹åˆ¥æ³¨é‡åŒ…å®¹æ€§ã€å¤šå…ƒæ€§åˆ¥èªåŒçš„å°Šé‡ï¼Œä¸¦æä¾›éäºŒå…ƒæ€§åˆ¥è¦–è§’çš„è³‡è¨Šã€‚';
                    break;
                case 'prefer-not-to-say':
                    genderContext = 'å°æ–¹é¸æ“‡ä¸é€éœ²æ€§åˆ¥ã€‚è«‹æä¾›ä¸­æ€§ã€åŒ…å®¹æ‰€æœ‰æ€§åˆ¥çš„è³‡è¨Šï¼Œä¸åšä»»ä½•æ€§åˆ¥å‡è¨­ã€‚';
                    break;
            }
            
            // æ·»åŠ  pre-test å¼±é»åˆ†æ
            let weaknessContext = '';
            if (hasCompletedPreTest && preTestResults.wrongTopics.length > 0) {
                weaknessContext = `\nã€å­¸ç¿’éœ€æ±‚åˆ†æã€‘
æ ¹æ“šåˆå§‹è©•ä¼°æ¸¬é©—ï¼Œä½¿ç”¨è€…åœ¨ä»¥ä¸‹ä¸»é¡Œç­”é¡Œä¸æ­£ç¢ºï¼Œéœ€è¦ç‰¹åˆ¥åŠ å¼·ï¼š${preTestResults.wrongTopics.join('ã€')}
åœ¨å°è©±ä¸­ï¼Œç•¶æ¶‰åŠé€™äº›ä¸»é¡Œæ™‚ï¼Œè«‹çµ¦äºˆæ›´è©³ç´°çš„è§£é‡‹å’Œå¼•å°ï¼Œå¹«åŠ©ä½¿ç”¨è€…å»ºç«‹æ­£ç¢ºçš„èªçŸ¥ã€‚`;
            }
            
            return `ä½ æ˜¯ IntiMate æ„›å¿ƒå¯†èªï¼Œä¸€ä½å°ˆæ¥­ã€ä¸­ç«‹ä¸”å¯Œæœ‰åŒç†å¿ƒçš„é’å°‘å¹´æ€§æ•™è‚²è¼”å°å¤¥ä¼´ã€‚

ã€ä½¿ç”¨è€…èƒŒæ™¯ã€‘
${ageContext}

${genderContext}${weaknessContext}

ã€å›ç­”åŸå‰‡ã€‘
1. ä»¥ IntiMate çš„èº«ä»½å›ç­”ï¼Œä½¿ç”¨æº«æš–ã€å‹å–„çš„èªæ°£
2. å›ç­”å¿…é ˆç°¡æ½”ã€å®‰å…¨ã€å®¢è§€ï¼Œä¸¦ä½¿ç”¨é©åˆå°æ–¹å¹´é½¡çš„èªè¨€
3. é¿å…çµ¦äºˆé†«ç™‚å»ºè­°ï¼Œå»ºè­°å°±é†«æ™‚éœ€è¦è«‹ä»–å€‘è«®è©¢å°ˆæ¥­é†«ç™‚äººå“¡
4. å§‹çµ‚å¼·èª¿åŒæ„æ¬Šã€å€‹äººå®‰å…¨å’Œå°Šé‡ä»–äººçš„é‡è¦æ€§
5. ä¿æŒéè©•åˆ¤æ€§æ…‹åº¦ï¼Œå°Šé‡å¤šå…ƒæ€§åˆ¥èªåŒå’Œæ€§å–å‘
6. å¦‚é‡åˆ°ä¸é©åˆè©²å¹´é½¡å±¤çš„å•é¡Œï¼Œæº«å’Œåœ°å¼•å°ä¸¦å»ºè­°å°‹æ±‚æˆå¹´äººå”åŠ©
7. ç•¶ä½¿ç”¨è€…è©¢å•èˆ‡å…¶å¼±é»ä¸»é¡Œç›¸é—œçš„å•é¡Œæ™‚ï¼Œæä¾›æ›´æ·±å…¥çš„èªªæ˜å’Œå¯¦ä¾‹`;
        }

        // --- æ¸¬é©—ç›¸é—œè®Šæ•¸èˆ‡é¡Œåº« ---
        let currentQuestionIndex = 0;
        let currentScore = 0;
        const quizQuestions = [
            {
                question: "1. é’æ˜¥æœŸèº«é«”ç™¼è‚²çš„é–‹å§‹é€šå¸¸ç”±ä»€éº¼æ¿€ç´ è§¸ç™¼ï¼Ÿ",
                options: ["é›Œæ¿€ç´  (Estrogen)", "çªå›ºé…® (Testosterone)", "ç”Ÿé•·æ¿€ç´  (Growth Hormone)", "èƒ°å³¶ç´  (Insulin)"],
                correctAnswer: "é›Œæ¿€ç´  (Estrogen)",
                explanation: "é’æ˜¥æœŸç™¼è‚²æ˜¯ç”±è…¦ä¸‹å‚é«”é‡‹æ”¾çš„æ¿€ç´ åˆºæ¿€åµå·¢æˆ–çªä¸¸ç”¢ç”Ÿé›Œæ¿€ç´ æˆ–çªé…®æ‰€è§¸ç™¼çš„ã€‚"
            },
            {
                question: "2. ä»€éº¼æ˜¯ã€åŒæ„æ¬Š (Consent)ã€çš„é—œéµè¦ç´ ï¼Ÿ",
                options: ["åªéœ€è¦ä¿æŒæ²‰é»˜å³å¯", "å¿…é ˆæ˜¯è‡ªé¡˜ã€æ¸…æ™°ä¸”æŒçºŒçš„", "åªéœ€è¦æˆå¹´äººåŒæ„", "å¿…é ˆæ˜¯å–®æ–¹é¢çš„"],
                correctAnswer: "å¿…é ˆæ˜¯è‡ªé¡˜ã€æ¸…æ™°ä¸”æŒçºŒçš„",
                explanation: "åŒæ„å¿…é ˆæ˜¯è‡ªé¡˜çµ¦äºˆçš„ã€æ¸…æ™°æ˜ç¢ºçš„ï¼Œä¸¦ä¸”å¯ä»¥éš¨æ™‚æ’¤å›ï¼ˆæŒçºŒæ€§ï¼‰ã€‚"
            },
            {
                question: "3. ç¶²è·¯è¦ªå¯†è¡Œç‚ºä¸­æœ€å¸¸è¦‹çš„é¢¨éšªæ˜¯ä»€éº¼ï¼Ÿ",
                options: ["æ‰‹æ©Ÿé›»é‡ä¸è¶³", "åœ–ç‰‡æª”æ¡ˆéå¤§", "å¤±å»å°ç…§ç‰‡å’Œè¨Šæ¯çš„æ§åˆ¶æ¬Š", "ä¸Šå‚³é€Ÿåº¦æ…¢"],
                correctAnswer: "å¤±å»å°ç…§ç‰‡å’Œè¨Šæ¯çš„æ§åˆ¶æ¬Š",
                explanation: "ä¸€æ—¦ç§å¯†å…§å®¹ç™¼é€å‡ºå»ï¼Œå°±æ°¸é ç„¡æ³•ä¿è­‰å®ƒä¸æœƒè¢«è¤‡è£½ã€åˆ†äº«æˆ–æ¿«ç”¨ã€‚"
            },
            {
                question: "4. ä»¥ä¸‹å“ªé …ä¸æ˜¯æ€§å‚³æŸ“ç—…ï¼ˆSTIï¼‰çš„é é˜²æ–¹æ³•ï¼Ÿ",
                options: ["ä½¿ç”¨ä¿éšªå¥—", "æ¥ç¨®ç–«è‹—ï¼ˆå¦‚ HPVï¼‰", "å®šæœŸæª¢æŸ¥", "å…±ç”¨ç‰™åˆ·"],
                correctAnswer: "å…±ç”¨ç‰™åˆ·",
                explanation: "å…±ç”¨ç‰™åˆ·èˆ‡æ€§å‚³æŸ“ç—…é é˜²ç„¡é—œã€‚å®‰å…¨æªæ–½åŒ…æ‹¬ä½¿ç”¨å±éšœã€æ¥ç¨®ç–«è‹—å’Œå®šæœŸç¯©æª¢ã€‚"
            },
            {
                question: "5. å¦‚æœå°è‡ªå·±çš„æ€§å‚¾å‘æˆ–æ€§åˆ¥èªåŒæ„Ÿåˆ°å›°æƒ‘ï¼Œæœ€å¥åº·çš„ä¸‹ä¸€æ­¥æ˜¯ï¼Ÿ",
                options: ["è‡ªå·±éš±è—èµ·ä¾†ï¼Œä¸è¦å‘Šè¨´ä»»ä½•äºº", "å°‹æ±‚å€¼å¾—ä¿¡ä»»çš„æˆå¹´äººæˆ–å°ˆæ¥­äººå£«è«®è©¢", "ç«‹åˆ»åšå‡ºæ±ºå®šä¸¦å…¬é–‹", "åœ¨ç¶²è·¯ä¸Šå°‹æ‰¾é™Œç”Ÿäººè¨è«–"],
                correctAnswer: "å°‹æ±‚å€¼å¾—ä¿¡ä»»çš„æˆå¹´äººæˆ–å°ˆæ¥­äººå£«è«®è©¢",
                explanation: "å°‹æ±‚å°ˆæ¥­è¼”å°æˆ–èˆ‡å€¼å¾—ä¿¡ä»»çš„æˆå¹´äººäº¤æµï¼Œæ˜¯æ¢ç´¢å€‹äººèº«ä»½çš„æœ€ä½³æ–¹å¼ã€‚"
            }
        ];


        // --- ä¸»è¦åŠŸèƒ½é‚è¼¯ ---

        async function sendMessage() {
            if (currentMode === 'quiz') return; 

            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            renderUserMessage(message);
            input.value = '';
            
            // é–å®šè¼¸å…¥å’Œç™¼é€æŒ‰éˆ•
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            await streamAIResponse(message);

            // è§£é–è¼¸å…¥å’Œç™¼é€æŒ‰éˆ•
            input.disabled = false;
            document.getElementById('send-btn').disabled = false;
            input.focus();
        }

        // ä¸²æµ AI å›æ‡‰ (å‘¼å« Vercel ä»£ç†)
        async function streamAIResponse(prompt) {
            const container = document.getElementById('messages-container');
            const aiMessage = document.createElement('div');
            aiMessage.className = 'flex justify-start message-slide-in';
            aiMessage.innerHTML = `
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                    <p class="text-sm font-bold mb-2 flex items-center">ğŸ’ IntiMate æ„›å¿ƒå¯†èª</p>
                    <div id="ai-response-${Date.now()}" class="text-base leading-relaxed"><span class="pulse-animation">ğŸ’­ æ€è€ƒä¸­...</span></div>
                </div>
            `;
            container.appendChild(aiMessage);
            const responseElement = aiMessage.querySelector('div.text-base');

            // æ»¾å‹•åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;

            try {
                // 1. å‘ Vercel ä»£ç†ç™¼é€è«‹æ±‚ï¼ˆä½¿ç”¨å‹•æ…‹ç”Ÿæˆçš„ç³»çµ±æŒ‡ä»¤ï¼‰
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // å°‡ Gemini æ‰€éœ€çš„çµæ§‹ï¼ˆåŒ…æ‹¬æ ¹æ“šä½¿ç”¨è€…è³‡æ–™å®šåˆ¶çš„ç³»çµ±æŒ‡ä»¤ï¼‰ç™¼é€çµ¦ Vercel ä»£ç†
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: getSystemInstruction() }] }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    responseElement.innerHTML = `<span class="text-red-400">é€£ç·šéŒ¯èª¤æˆ–å¯†é‘°ç„¡æ•ˆ:</span> è«‹æª¢æŸ¥ä»£ç†ä¼ºæœå™¨æˆ– Vercel ç’°å¢ƒè®Šæ•¸ã€‚`;
                    return;
                }
                
                // 2. è™•ç†ä¸²æµ
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                
                responseElement.textContent = ''; // æ¸…é™¤ '...æ€è€ƒä¸­'
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // Vercel ä»£ç†æœƒå°‡åŸå§‹å›æ‡‰ä¸²æµè½‰ç™¼å›ä¾†
                    const chunk = decoder.decode(value, { stream: true });
                    responseElement.textContent += chunk;
                    container.scrollTop = container.scrollHeight;
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                responseElement.innerHTML = `<span class="text-red-400">ç¶²è·¯æˆ–ä»£ç†æ•…éšœ:</span> è«‹æª¢æŸ¥é€£ç·šæˆ– Vercel éƒ¨ç½²ã€‚`;
            }
        }

        // æ¸²æŸ“ä½¿ç”¨è€…è¨Šæ¯ (èˆ‡å…ˆå‰ç‰ˆæœ¬ç›¸åŒ)
        function renderUserMessage(text) {
            const container = document.getElementById('messages-container');
            const messageElement = document.createElement('div');
            messageElement.className = 'flex justify-end message-slide-in';
            messageElement.innerHTML = `
                <div class="bg-gradient-to-br from-blue-500 to-cyan-400 text-white p-4 rounded-2xl rounded-br-sm max-w-lg shadow-xl">
                    <p class="text-base leading-relaxed font-medium">${text}</p>
                </div>
            `;
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        // ç¶å®š Enter éµ (èˆ‡å…ˆå‰ç‰ˆæœ¬ç›¸åŒ)
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- æ¸¬é©—æ¨¡å¼é‚è¼¯ (èˆ‡å…ˆå‰ç‰ˆæœ¬ç›¸åŒ) ---
        function toggleMode() {
            const chatView = document.getElementById('chat-mode-view');
            const quizView = document.getElementById('quiz-mode-view');
            const toggleBtn = document.getElementById('mode-toggle-btn');
            const inputContainer = document.getElementById('chat-input-container');
            const quizPrompt = document.getElementById('quiz-prompt');
            const modeDisplay = document.getElementById('mode-display');

            if (currentMode === 'chat') {
                currentMode = 'quiz';
                chatView.classList.add('hidden');
                quizView.classList.remove('hidden');
                toggleBtn.innerHTML = 'ğŸ’¬ è¿”å›';
                inputContainer.classList.add('hidden');
                quizPrompt.classList.remove('hidden');
                
                currentQuestionIndex = 0;
                currentScore = 0;
                renderQuiz();

            } else {
                currentMode = 'chat';
                chatView.classList.remove('hidden');
                quizView.classList.add('hidden');
                toggleBtn.innerHTML = 'ğŸ¯ æ¸¬é©—';
                inputContainer.classList.remove('hidden');
                quizPrompt.classList.add('hidden');
            }
        }

        function renderQuiz() {
            const quizContent = document.getElementById('quiz-content');

            if (currentQuestionIndex >= quizQuestions.length) {
                const scorePercent = Math.round((currentScore / quizQuestions.length) * 100);
                const emoji = scorePercent >= 80 ? 'ğŸ‰' : scorePercent >= 60 ? 'ğŸ‘' : 'ğŸ’ª';
                quizContent.innerHTML = `
                    <div class="text-center p-8 bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl border-2 border-purple-300">
                        <div class="text-6xl mb-4">${emoji}</div>
                        <h3 class="text-3xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">æ¸¬é©—å®Œæˆï¼</h3>
                        <p class="text-xl mb-4 text-gray-700">æ‚¨çš„æœ€çµ‚åˆ†æ•¸æ˜¯ï¼š</p>
                        <div class="text-5xl font-extrabold bg-gradient-to-r from-blue-600 to-cyan-500 bg-clip-text text-transparent mb-4">${currentScore} / ${quizQuestions.length}</div>
                        <p class="text-lg text-gray-600 mb-6">æŒæ¡åº¦ï¼š${scorePercent}% ğŸ’¯</p>
                        <button onclick="toggleMode()" class="mt-4 px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold rounded-full transition duration-200 shadow-lg hover:shadow-xl active:scale-95">
                            ğŸ’¬ è¿”å›å°è©±æ¨¡å¼
                        </button>
                    </div>
                `;
                return;
            }

            const questionData = quizQuestions[currentQuestionIndex];
            const optionsContainer = document.createElement('div');
            optionsContainer.id = 'quiz-options';
            optionsContainer.className = 'mt-4 space-y-3';
            
            let optionsHTML = '';
            questionData.options.forEach((option, i) => {
                optionsHTML += `
                    <button onclick="checkAnswer(${i})" 
                            id="option-btn-${i}"
                            class="quiz-option-btn w-full p-5 my-2 text-left rounded-2xl transition-all 
                                   bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 
                                   border-2 border-purple-300 hover:border-purple-400
                                   disabled:opacity-75 disabled:cursor-not-allowed text-base font-semibold shadow-md hover:shadow-lg
                                   transform hover:scale-105 active:scale-95 text-gray-800">
                        <span class="text-purple-600">${String.fromCharCode(65 + i)}.</span> ${option}
                    </button>
                `;
            });

            quizContent.innerHTML = `
                <div class="mb-6">
                    <p class="text-sm font-semibold text-purple-600 mb-3 bg-purple-100 inline-block px-4 py-2 rounded-full">ğŸ“Š ç¬¬ ${currentQuestionIndex + 1} é¡Œ / å…± ${quizQuestions.length} é¡Œ</p>
                    <h3 class="text-xl font-bold text-gray-800 leading-relaxed">${questionData.question}</h3>
                </div>
                ${optionsHTML}
            `;
        }

        function checkAnswer(selectedIndex) {
            const question = quizQuestions[currentQuestionIndex];
            const isCorrect = question.correctAnswer === question.options[selectedIndex];
            const optionsContainer = document.getElementById('quiz-options');
            const buttons = optionsContainer.querySelectorAll('button');

            buttons.forEach(button => {
                button.disabled = true;
                button.classList.remove('hover:from-purple-200', 'hover:to-pink-200', 'hover:scale-105', 'hover:border-purple-400'); 
            });

            buttons.forEach((button, index) => {
                if (index === selectedIndex) {
                    if (isCorrect) {
                        button.className = 'quiz-option-btn w-full p-5 my-2 text-left rounded-2xl transition-all bg-gradient-to-r from-green-400 to-emerald-500 ring-4 ring-green-300 text-white font-bold shadow-xl';
                        button.innerHTML = 'âœ… ' + button.innerHTML;
                    } else {
                        button.className = 'quiz-option-btn w-full p-5 my-2 text-left rounded-2xl transition-all bg-gradient-to-r from-red-400 to-pink-500 ring-4 ring-red-300 text-white font-bold shadow-xl';
                        button.innerHTML = 'âŒ ' + button.innerHTML;
                    }
                }
                
                if (question.options[index] === question.correctAnswer && index !== selectedIndex) {
                    button.className = 'quiz-option-btn w-full p-5 my-2 text-left rounded-2xl transition-all bg-gradient-to-r from-green-500 to-emerald-600 ring-4 ring-green-400 text-white font-bold shadow-xl';
                    button.innerHTML = 'âœ… ' + button.innerHTML;
                }
            });

            if (isCorrect) {
                currentScore++;
            }

            setTimeout(() => {
                currentQuestionIndex++;
                renderQuiz();
            }, 2000); 
        }

    </script>
</body>
</html>
