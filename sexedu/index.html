<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntiMate 愛心密語 - 青少年性教育輔導平台</title>
    <!-- 適用於 iPad 模擬 App 的設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/667eea/ffffff?text=IntiMate">

    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Poppins 字體 - 更年輕活力 */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        #input-area {
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .message-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Old School Styles */
        .old-school-page {
            background: #c0c0c0;
            font-family: 'Times New Roman', Times, serif;
        }
        
        .old-school-box {
            background: #ffffff;
            border: 3px solid #808080;
            box-shadow: 3px 3px 0px #000000;
        }
        
        .old-school-button {
            background: #c0c0c0;
            border: 2px outset #ffffff;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            padding: 8px 24px;
            cursor: pointer;
        }
        
        .old-school-button:active {
            border-style: inset;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .blink {
            animation: blink 1s step-start infinite;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
        }
        
        /* Transition Page Styles */
        @keyframes morphBackground {
            0% { background: #000000; }
            25% { background: #1a1a2e; }
            50% { background: #16213e; }
            75% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%); }
            100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        }
        
        @keyframes colorShift {
            0% { color: #00ff00; }
            50% { color: #00ffff; }
            75% { color: #ff00ff; }
            100% { color: #ffffff; }
        }
        
        @keyframes fontTransform {
            0% { 
                font-family: 'Courier New', monospace; 
                font-size: 18px;
            }
            100% { 
                font-family: 'Poppins', sans-serif; 
                font-size: 28px;
            }
        }
        
        .morphing-bg {
            animation: morphBackground 4s ease-in-out forwards;
        }
        
        .color-shift {
            animation: colorShift 3s ease-in-out forwards;
        }
        
        .font-transform {
            animation: fontTransform 3s ease-in-out forwards;
        }
        
        @keyframes scaleUp {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .scale-up {
            animation: scaleUp 1s ease-out forwards;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a2e;
        }
        
        .dark-mode #modern-app {
            background: #1a1a2e;
        }
        
        .dark-mode #header-bar {
            background: linear-gradient(to right, #4c1d95, #7c2d92, #be185d) !important;
        }
        
        .dark-mode main {
            background: linear-gradient(to bottom right, #1e1e2e, #2a2a3e, #1a1a2e) !important;
        }
        
        .dark-mode .bg-white {
            background: #2a2a3e !important;
        }
        
        .dark-mode .text-gray-700,
        .dark-mode .text-gray-800 {
            color: #e5e5e5 !important;
        }
        
        .dark-mode .text-gray-600 {
            color: #b0b0b0 !important;
        }
        
        .dark-mode .text-gray-500 {
            color: #888888 !important;
        }
        
        .dark-mode input {
            background: linear-gradient(to right, #3a3a52, #4a4a62) !important;
            color: #ffffff !important;
            border-color: #5a5a7a !important;
        }
        
        .dark-mode input::placeholder {
            color: #9ca3af !important;
        }
        
        .dark-mode .border-purple-200 {
            border-color: #4a4a6a !important;
        }
        
        .dark-mode .border-purple-300 {
            border-color: #5a5a7a !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-purple-50 {
            background: linear-gradient(to bottom right, #2a2a42, #3a3a52) !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-blue-50 {
            background: linear-gradient(to bottom right, #1e3a5f, #2a4a6f) !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-pink-50 {
            background: linear-gradient(to bottom right, #4a2a42, #5a3a52) !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-gray-50 {
            background: linear-gradient(to bottom right, #2a2a2a, #3a3a3a) !important;
        }
        
        .dark-mode .bg-amber-50 {
            background: #3a3a2e !important;
        }
        
        .dark-mode .border-amber-400 {
            border-color: #d97706 !important;
        }
        
        .dark-mode .text-amber-800 {
            color: #fbbf24 !important;
        }
        
        .dark-mode .text-amber-600 {
            color: #f59e0b !important;
        }
        
        /* User Info Page Dark Mode */
        .dark-mode #user-info-page {
            background: linear-gradient(135deg, #2d3561 0%, #4a3f6b 100%) !important;
        }
        
        .dark-mode #user-info-page .bg-white\/95 {
            background: rgba(30, 30, 46, 0.95) !important;
        }
        
        /* Pre-Test and Post-Test Dark Mode */
        .dark-mode #pre-test-page {
            background: linear-gradient(135deg, #2d3561 0%, #4a3f6b 100%) !important;
        }
        
        .dark-mode #pre-test-page .bg-white\/95,
        .dark-mode #post-test-view .bg-white {
            background: rgba(30, 30, 46, 0.95) !important;
        }
        
        .dark-mode .border-green-300 {
            border-color: #22c55e !important;
        }
        
        .dark-mode .border-green-200 {
            border-color: #4ade80 !important;
        }
        
        .dark-mode .text-green-600 {
            color: #4ade80 !important;
        }
        
        .dark-mode .bg-green-50 {
            background: #1a3a2e !important;
        }
        
        .dark-mode .bg-green-100 {
            background: #2a4a3e !important;
        }
        
        /* Quiz Mode Dark Mode */
        .dark-mode #quiz-mode-view .bg-white {
            background: #2a2a3e !important;
            border-color: #5a5a7a !important;
        }
        
        .dark-mode .bg-gradient-to-br.from-purple-100 {
            background: linear-gradient(to bottom right, #2a2a42, #3a3a52) !important;
        }
        
        /* Button Hover States in Dark Mode */
        .dark-mode button:hover {
            filter: brightness(1.2);
        }
        
        .dark-mode .age-btn:hover,
        .dark-mode .gender-btn:hover {
            filter: brightness(1.15);
        }
        
        /* Ring colors in Dark Mode */
        .dark-mode .ring-purple-500 {
            --tw-ring-color: #8b5cf6 !important;
        }
        
        .dark-mode .ring-4 {
            box-shadow: 0 0 0 4px var(--tw-ring-color) !important;
        }
        
        /* Green success text in dark mode */
        .dark-mode .text-green-600 {
            color: #4ade80 !important;
        }
        
        /* Smooth theme transition */
        body {
            transition: background-color 0.3s ease;
        }
        
        #modern-app,
        main,
        input,
        button {
            transition: all 0.3s ease;
        }
        
        /* Responsive message bubbles */
        @media (max-width: 640px) {
            #messages-container > div > div {
                max-width: 85% !important;
            }
        }
    </style>
</head>
<body>

    <!-- Old School Landing Page -->
    <div id="old-school-page" class="old-school-page w-full h-screen flex items-center justify-center">
        <div class="old-school-box p-12 max-w-2xl mx-4">
            <h1 style="font-size: 24px; margin-bottom: 20px; text-align: center; font-weight: bold;">
                兩性健康資訊站 v1.0<br>
                Gender Health Information Station
            </h1>
            <hr style="border: 1px solid #808080; margin: 20px 0;">
            <p style="font-size: 16px; line-height: 1.6; margin-bottom: 30px; text-align: center;">
                Welcome to the Gender Health Information Station.<br>
                An Educational Resource for Youth Development and Wellness.<br>
                Copyright © 1995-2025. All Rights Reserved.<br><br>
                Press the button below to initialize the system.
            </p>
            <div style="text-align: center;">
                <button class="old-school-button" onclick="startSystem()">
                    START SYSTEM
                </button>
            </div>
            <p style="font-size: 12px; margin-top: 30px; text-align: center; color: #666;">
                System Requirements: 486DX/33MHz or higher, 8MB RAM, VGA Display
            </p>
        </div>
    </div>

    <!-- Loading/Transition Page -->
    <div id="loading-page" class="hidden w-full h-screen flex items-center justify-center bg-black">
        <div class="text-center px-4">
            <div id="loading-content" style="font-family: 'Courier New', monospace; color: #00ff00; font-size: 18px; line-height: 1.8;">
                <p id="init-text">INITIALIZING SYSTEM...</p>
                <p id="loading-text">LOADING MODULES... [<span id="progress">0</span>%]</p>
                <p class="blink" id="cursor">_</p>
            </div>
            <div id="transition-content" style="display: none; margin-top: 60px;">
                <p id="joke-text" style="font-family: 'Courier New', monospace; color: #00ff00; font-size: 24px; margin-bottom: 40px;">
                    Just kidding!<br>
                    We're not that old fashion! 😄
                </p>
                <p id="upgrade-text" class="color-shift font-transform" style="font-family: 'Courier New', monospace; color: #00ff00; font-size: 18px; margin-top: 30px; display: none;">
                    🚀 Upgrading to modern interface...<br>
                    ✨ Adding colors and gradients...<br>
                    💫 Initializing smooth animations...<br>
                    🎨 Loading beautiful design...
                </p>
            </div>
        </div>
    </div>

    <!-- Pre-Test Page -->
    <div id="pre-test-page" class="hidden w-full h-screen flex items-center justify-center p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="w-full max-w-3xl bg-white/95 rounded-3xl shadow-2xl p-6 md:p-10">
            <div class="text-center mb-6">
                <h2 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3">
                    📋 知識水平評估測驗
                </h2>
                <p class="text-gray-600 text-sm md:text-base">
                    在開始使用 IntiMate 前，讓我們先了解一下你目前的知識水平<br>
                    <span class="text-purple-600 font-semibold">這將幫助我們提供更適合你的指導</span>
                </p>
            </div>
            
            <div id="pre-test-content" class="space-y-4">
                <!-- Questions will be dynamically generated -->
            </div>
            
            <div id="pre-test-result" class="hidden text-center space-y-4">
                <div class="text-6xl mb-4">📊</div>
                <h3 class="text-2xl font-bold text-gray-800">測驗完成！</h3>
                <p class="text-lg text-gray-600">正在分析你的結果...</p>
                <div class="animate-pulse">
                    <div class="h-2 bg-purple-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Info Collection Page -->
    <div id="user-info-page" class="hidden w-full h-screen flex items-center justify-center p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="w-full max-w-2xl bg-white/95 rounded-3xl shadow-2xl p-8 md:p-12">
            <h2 class="text-3xl md:text-4xl font-bold text-center mb-3 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                歡迎使用 IntiMate 愛心密語 ✨
            </h2>
            <p class="text-center text-gray-600 mb-8 text-base md:text-lg">
                為了提供更適合您的建議，請先填寫以下資訊<br>
                <span class="text-sm text-purple-600 font-semibold">（IntiMate 專為10-18歲青少年設計）</span>
            </p>

            <!-- Age Group Selection -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-700 mb-4">📅 請選擇您的年齡段：</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="selectAge('10-13')" id="age-10-13" class="age-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">🧒</div>
                        <div class="font-bold mb-1">10-13歲</div>
                        <div class="text-xs text-gray-600">探索期 / 基礎認知</div>
                    </button>
                    <button onclick="selectAge('13-15')" id="age-13-15" class="age-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">🧑</div>
                        <div class="font-bold mb-1">13-15歲</div>
                        <div class="text-xs text-gray-600">過渡期 / 社會認知</div>
                    </button>
                    <button onclick="selectAge('16-18')" id="age-16-18" class="age-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">👨‍🎓</div>
                        <div class="font-bold mb-1">16-18歲</div>
                        <div class="text-xs text-gray-600">成熟期 / 關係與倫理</div>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-3 text-center">
                    ⚠️ 本系統僅服務18歲以下青少年
                </p>
            </div>

            <!-- Gender Selection -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-700 mb-4">👤 請選擇您的性別：</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="selectGender('male')" id="gender-male" class="gender-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-blue-50 to-cyan-50 hover:from-blue-100 hover:to-cyan-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">👦</div>
                        男
                    </button>
                    <button onclick="selectGender('female')" id="gender-female" class="gender-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-pink-50 to-rose-50 hover:from-pink-100 hover:to-rose-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">👧</div>
                        女
                    </button>
                    <button onclick="selectGender('other')" id="gender-other" class="gender-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-purple-50 to-indigo-50 hover:from-purple-100 hover:to-indigo-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">🌈</div>
                        其他
                    </button>
                    <button onclick="selectGender('prefer-not-to-say')" id="gender-prefer-not-to-say" class="gender-btn p-5 rounded-xl border-3 border-purple-300 bg-gradient-to-br from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 transition-all duration-200 hover:scale-105 active:scale-95 font-semibold text-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">🤐</div>
                        不願透露
                    </button>
                </div>
            </div>

            <!-- Confirmation Button -->
            <div class="text-center pt-4">
                <button onclick="confirmUserInfo()" id="confirm-btn" disabled class="px-10 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-full text-lg transition-all duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 active:scale-95">
                    開始使用 🚀
                </button>
                <p id="selection-hint" class="text-sm text-gray-500 mt-4">請先選擇年齡段和性別</p>
            </div>
        </div>
    </div>

    <!-- Modern App (Hidden Initially) -->
    <div id="modern-app" class="hidden w-full h-screen flex flex-col overflow-hidden bg-white">
        
        <!-- Header (狀態欄) -->
        <header id="header-bar" class="p-4 md:p-5 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 flex justify-between items-center text-white shadow-lg">
            <div class="flex items-center space-x-2">
                <span id="ai-status" class="hidden sm:inline-block text-xs sm:text-sm font-semibold bg-white/20 px-2 sm:px-3 py-1 rounded-full backdrop-blur-sm">✨ 已連線</span>
                <button id="theme-toggle-btn" 
                        onclick="toggleTheme()"
                        class="px-2 sm:px-3 py-1 bg-white/20 hover:bg-white/30 text-sm font-semibold rounded-full transition duration-200 active:scale-95 backdrop-blur-sm"
                        title="切換主題">
                    <span id="theme-icon">☀️</span>
                </button>
            </div>
            <div class="text-lg sm:text-xl md:text-2xl font-bold" id="mode-display">
                💝 IntiMate 愛心密語
            </div>
            <div class="flex items-center space-x-2">
                <button id="post-test-btn" 
                        onclick="startPostTest()"
                        class="hidden px-3 sm:px-4 py-2 bg-green-500/90 hover:bg-green-600 text-white text-xs sm:text-sm font-semibold rounded-full transition duration-200 active:scale-95 shadow-lg hover:shadow-xl"
                        title="檢視學習成效">
                    📈 成效測驗
                </button>
                <button id="mode-toggle-btn" 
                        onclick="toggleMode()"
                        class="px-3 sm:px-4 py-2 bg-white/90 hover:bg-white text-purple-600 text-xs sm:text-sm font-semibold rounded-full transition duration-200 active:scale-95 shadow-lg hover:shadow-xl">
                    🎯 知識測驗
                </button>
            </div>
        </header>

        <!-- 主內容區 -->
        <main class="flex-grow p-4 md:p-6 overflow-y-auto hide-scrollbar relative bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
            
            <!-- Chat Mode -->
            <div id="chat-mode-view" class="max-w-4xl mx-auto w-full space-y-4">
                <div id="messages-container" class="space-y-4 pb-4">
                    <!-- 歡迎訊息將由 JavaScript 動態生成 -->
                </div>
            </div>
            
            <!-- Quiz Mode -->
            <div id="quiz-mode-view" class="hidden flex flex-col items-center justify-center min-h-full p-4">
                <div class="w-full max-w-2xl bg-white p-6 md:p-8 rounded-3xl shadow-2xl border-4 border-purple-300">
                    <h2 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6 pb-3 border-b-2 border-purple-200">🎯 性教育知識測驗</h2>
                    <div id="quiz-content" class="text-gray-800">
                        <p class="text-base md:text-lg font-medium text-center">點擊下方按鈕開始測驗！🚀</p>
                    </div>
                </div>
            </div>
            
            <!-- Post-Test Mode -->
            <div id="post-test-view" class="hidden flex flex-col items-center justify-center min-h-full p-4">
                <div class="w-full max-w-3xl bg-white p-6 md:p-8 rounded-3xl shadow-2xl border-4 border-green-300">
                    <h2 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent mb-6 pb-3 border-b-2 border-green-200">📈 學習成效測驗</h2>
                    <div id="post-test-content" class="text-gray-800">
                        <!-- Post-test questions will be dynamically generated -->
                    </div>
                </div>
            </div>

        </main>

        <!-- 輸入區 -->
        <footer id="input-area" class="bg-white p-4 md:p-5 border-t-2 border-purple-200">
            <div id="chat-input-container" class="max-w-4xl mx-auto w-full flex flex-col space-y-3">
                <div class="flex space-x-2 sm:space-x-3">
                    <input type="text" id="user-input" placeholder="💭 請輸入您的問題..."
                           class="flex-grow p-3 sm:p-4 text-sm sm:text-base bg-gradient-to-r from-purple-100 to-pink-100 text-gray-800 border-2 border-purple-300 rounded-full focus:outline-none focus:ring-4 focus:ring-purple-300 placeholder-purple-400 transition duration-200 font-medium">
                    <button id="send-btn" onclick="sendMessage()"
                            class="px-4 sm:px-8 py-3 sm:py-4 text-sm sm:text-base bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold rounded-full transition duration-200 active:scale-95 shadow-lg hover:shadow-xl whitespace-nowrap">
                        🚀 發送
                    </button>
                </div>
                
                <!-- Disclaimer -->
                <div class="bg-amber-50 border-l-4 border-amber-400 p-2 sm:p-3 rounded-lg">
                    <div class="flex items-start">
                        <span class="text-amber-600 text-base sm:text-lg mr-2 flex-shrink-0">⚠️</span>
                        <p class="text-xs leading-relaxed text-amber-800">
                            <span class="font-bold">免責聲明：</span>本系統提供的資訊僅供教育參考，<span class="font-semibold">不構成醫學建議、診斷或治療</span>。如有健康疑慮或需要專業協助，請諮詢合格的醫護人員、學校輔導老師或撥打相關諮詢專線。
                        </p>
                    </div>
                </div>
            </div>
            <div id="quiz-prompt" class="hidden text-center text-purple-600 py-2 font-medium">
                📝 請在測驗區塊完成作答。
            </div>
        </footer>

    </div><!-- End of modern-app -->

    <script>
        // --- User Profile Storage ---
        let userAge = null;
        let userGender = null;
        
        // --- Test Data Storage ---
        let preTestResults = {
            score: 0,
            total: 0,
            wrongTopics: [], // Topics user got wrong
            answers: [] // User's answers
        };
        
        let postTestResults = {
            score: 0,
            total: 0,
            answers: []
        };
        
        let hasCompletedPreTest = false;
        
        // --- Pre-Test Questions (Assessment Quiz) ---
        const preTestQuestions = [
            {
                id: 1,
                topic: '青春期生理變化',
                question: '青春期開始的主要標誌是什麼？',
                options: [
                    '身高突然增長',
                    '第二性徵開始出現',
                    '開始上中學',
                    '喜歡與異性交往'
                ],
                correctAnswer: 1,
                explanation: '青春期的主要標誌是第二性徵的出現，包括性器官發育、體毛生長等。'
            },
            {
                id: 2,
                topic: '同意權',
                question: '關於「同意權」，以下哪個說法是正確的？',
                options: [
                    '一旦同意就不能改變主意',
                    '沉默代表同意',
                    '同意必須是自願、清晰且可以隨時撤回的',
                    '只要對方是戀人就不需要每次都問'
                ],
                correctAnswer: 2,
                explanation: '同意權必須是自願給予的、清晰明確的，並且可以隨時撤回。'
            },
            {
                id: 3,
                topic: '網路安全',
                question: '以下哪種行為在網路上最安全？',
                options: [
                    '與網友分享自己的私密照片',
                    '在社交媒體上公開個人詳細資訊',
                    '保護個人隱私，不輕易分享敏感資訊',
                    '與陌生網友約見面'
                ],
                correctAnswer: 2,
                explanation: '保護個人隱私和敏感資訊是網路安全的關鍵。一旦資料外流，很難收回。'
            },
            {
                id: 4,
                topic: '性傳染病預防',
                question: '以下哪項不是預防性傳染病（STI）的有效方法？',
                options: [
                    '正確使用保險套',
                    '定期進行健康檢查',
                    '避免與多人發生性行為',
                    '只和看起來健康的人發生關係'
                ],
                correctAnswer: 3,
                explanation: '外表無法判斷是否有STI。預防需要正確使用保險套、定期檢查等科學方法。'
            },
            {
                id: 5,
                topic: '身體自主權',
                question: '如果有人讓你感到不舒服或不尊重你的身體界線，你應該？',
                options: [
                    '忍耐不說，怕破壞關係',
                    '明確表達拒絕，並尋求信任的成人協助',
                    '覺得是自己的問題',
                    '在社交媒體上發洩'
                ],
                correctAnswer: 1,
                explanation: '你有權利保護自己的身體界線。明確拒絕並尋求幫助是最正確的做法。'
            },
            {
                id: 6,
                topic: '健康關係',
                question: '健康的戀愛關係應該包括以下哪項？',
                options: [
                    '其中一方完全聽從另一方',
                    '互相尊重、信任和溝通',
                    '時常檢查對方手機確保忠誠',
                    '為了對方放棄所有朋友'
                ],
                correctAnswer: 1,
                explanation: '健康的關係建立在互相尊重、信任和良好溝通的基礎上。'
            }
        ];
        
        // --- Theme Management ---
        let currentTheme = localStorage.getItem('theme') || 'bright';
        
        // Initialize theme on page load
        function initTheme() {
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                updateThemeIcon();
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            if (currentTheme === 'bright') {
                currentTheme = 'dark';
                document.body.classList.add('dark-mode');
            } else {
                currentTheme = 'bright';
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
        }
        
        // Update theme icon
        function updateThemeIcon() {
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = currentTheme === 'dark' ? '🌙' : '☀️';
            }
        }
        
        // Call initTheme when page loads
        initTheme();

        // --- Page Transition Logic ---
        function startSystem() {
            const oldSchoolPage = document.getElementById('old-school-page');
            const loadingPage = document.getElementById('loading-page');
            const userInfoPage = document.getElementById('user-info-page');
            const loadingContent = document.getElementById('loading-content');
            const transitionContent = document.getElementById('transition-content');
            const upgradeText = document.getElementById('upgrade-text');
            const cursor = document.getElementById('cursor');
            
            // Fade out old school page
            oldSchoolPage.classList.add('fade-out');
            
            setTimeout(() => {
                oldSchoolPage.classList.add('hidden');
                loadingPage.classList.remove('hidden');
                loadingPage.classList.add('fade-in');
                
                // Simulate loading progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 25;
                    if (progress > 100) progress = 100;
                    document.getElementById('progress').textContent = Math.floor(progress);
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        
                        // Hide cursor and fade out loading content
                        cursor.style.display = 'none';
                        
                        setTimeout(() => {
                            loadingContent.classList.add('fade-out');
                            
                            setTimeout(() => {
                                loadingContent.style.display = 'none';
                                transitionContent.style.display = 'block';
                                
                                // Show the joke text
                                setTimeout(() => {
                                    // Start background morphing
                                    loadingPage.classList.add('morphing-bg');
                                    
                                    // Show upgrade text after joke
                                    setTimeout(() => {
                                        upgradeText.style.display = 'block';
                                        
                                        // Wait for animations to complete
                                        setTimeout(() => {
                                            // Transition to user info page
                                            loadingPage.classList.add('fade-out');
                                            
                                            setTimeout(() => {
                                                loadingPage.classList.add('hidden');
                                                userInfoPage.classList.remove('hidden');
                                                userInfoPage.classList.add('scale-up');
                                            }, 800);
                                        }, 4000); // Wait for morphing animations
                                    }, 1500); // Delay before showing upgrade text
                                }, 300);
                            }, 500);
                        }, 500);
                    }
                }, 150);
            }, 500);
        }

        // --- User Info Collection Logic ---
        function selectAge(age) {
            userAge = age;
            
            // Visual feedback - highlight selected
            document.querySelectorAll('.age-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-purple-500', 'bg-gradient-to-br', 'from-purple-200', 'to-pink-200');
                btn.classList.add('bg-gradient-to-br', 'from-purple-50', 'to-pink-50');
            });
            document.getElementById(`age-${age}`).classList.remove('from-purple-50', 'to-pink-50');
            document.getElementById(`age-${age}`).classList.add('from-purple-200', 'to-pink-200', 'ring-4', 'ring-purple-500');
            
            checkUserInfoComplete();
        }

        function selectGender(gender) {
            userGender = gender;
            
            // Visual feedback - highlight selected
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-purple-500');
            });
            document.getElementById(`gender-${gender}`).classList.add('ring-4', 'ring-purple-500');
            
            checkUserInfoComplete();
        }

        function checkUserInfoComplete() {
            const confirmBtn = document.getElementById('confirm-btn');
            const hint = document.getElementById('selection-hint');
            
            if (userAge && userGender) {
                confirmBtn.disabled = false;
                hint.textContent = '✅ 資料完整！可以開始使用了';
                hint.classList.remove('text-gray-500');
                hint.classList.add('text-green-600', 'font-semibold');
            }
        }

        function confirmUserInfo() {
            const userInfoPage = document.getElementById('user-info-page');
            const preTestPage = document.getElementById('pre-test-page');
            
            userInfoPage.classList.add('fade-out');
            
            setTimeout(() => {
                userInfoPage.classList.add('hidden');
                preTestPage.classList.remove('hidden');
                preTestPage.classList.add('scale-up');
                
                // 開始 Pre-Test
                startPreTest();
            }, 500);
        }
        
        // --- Pre-Test Functions ---
        let currentPreTestQuestion = 0;
        
        function startPreTest() {
            currentPreTestQuestion = 0;
            preTestResults = {
                score: 0,
                total: preTestQuestions.length,
                wrongTopics: [],
                answers: []
            };
            renderPreTestQuestion();
        }
        
        function renderPreTestQuestion() {
            const content = document.getElementById('pre-test-content');
            
            if (currentPreTestQuestion >= preTestQuestions.length) {
                // 測驗完成
                completePreTest();
                return;
            }
            
            const q = preTestQuestions[currentPreTestQuestion];
            const progress = ((currentPreTestQuestion / preTestQuestions.length) * 100).toFixed(0);
            
            content.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-purple-600">題目 ${currentPreTestQuestion + 1} / ${preTestQuestions.length}</span>
                        <span class="text-sm text-gray-500">${progress}%</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 md:p-6 rounded-2xl mb-4">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 mb-4">${q.question}</h3>
                    <div class="space-y-3">
                        ${q.options.map((option, index) => `
                            <button onclick="answerPreTest(${index})" 
                                    class="w-full p-4 text-left rounded-xl transition-all bg-white hover:bg-purple-100 border-2 border-purple-200 hover:border-purple-400 text-gray-700 hover:text-gray-900 font-medium text-sm md:text-base">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function answerPreTest(selectedIndex) {
            const q = preTestQuestions[currentPreTestQuestion];
            const isCorrect = selectedIndex === q.correctAnswer;
            
            // 記錄答案
            preTestResults.answers.push({
                questionId: q.id,
                topic: q.topic,
                correct: isCorrect,
                selectedAnswer: selectedIndex
            });
            
            if (isCorrect) {
                preTestResults.score++;
            } else {
                // 記錄答錯的主題
                if (!preTestResults.wrongTopics.includes(q.topic)) {
                    preTestResults.wrongTopics.push(q.topic);
                }
            }
            
            // 下一題
            currentPreTestQuestion++;
            renderPreTestQuestion();
        }
        
        function completePreTest() {
            const content = document.getElementById('pre-test-content');
            const result = document.getElementById('pre-test-result');
            
            content.classList.add('hidden');
            result.classList.remove('hidden');
            
            hasCompletedPreTest = true;
            
            // 2秒後進入主應用
            setTimeout(() => {
                const preTestPage = document.getElementById('pre-test-page');
                const modernApp = document.getElementById('modern-app');
                
                preTestPage.classList.add('fade-out');
                
                setTimeout(() => {
                    preTestPage.classList.add('hidden');
                    modernApp.classList.remove('hidden');
                    modernApp.classList.add('scale-up');
                    
                    // 顯示個性化歡迎訊息（包含測驗結果分析）
                    showWelcomeMessageWithPreTestAnalysis();
                    
                    // 顯示 Post-Test 按鈕
                    document.getElementById('post-test-btn').classList.remove('hidden');
                    
                    // 更新主題圖標
                    updateThemeIcon();
                }, 500);
            }, 2000);
        }

        // 生成並顯示帶有 Pre-Test 分析的歡迎訊息
        function showWelcomeMessageWithPreTestAnalysis() {
            const container = document.getElementById('messages-container');
            const scorePercent = Math.round((preTestResults.score / preTestResults.total) * 100);
            
            let greeting = '';
            let performanceMsg = '';
            
            // 根據年齡段定制歡迎語
            switch(userAge) {
                case '10-13':
                    greeting = '嗨！很高興認識你！👋';
                    break;
                case '13-15':
                    greeting = '嗨！歡迎來到 IntiMate！😊';
                    break;
                case '16-18':
                    greeting = '你好！歡迎使用 IntiMate！👋';
                    break;
            }
            
            // 根據分數給予評價
            if (scorePercent >= 80) {
                performanceMsg = '你對性教育知識有很好的理解！👏';
            } else if (scorePercent >= 60) {
                performanceMsg = '你有一定的基礎知識，我會幫助你進一步提升！💪';
            } else {
                performanceMsg = '別擔心！我會用心指導你，幫助你建立正確的知識。✨';
            }
            
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'flex justify-start message-slide-in';
            welcomeMessage.innerHTML = `
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                    <p class="text-sm font-bold mb-2 flex items-center">💝 IntiMate 愛心密語</p>
                    <p class="text-lg font-semibold mb-2">${greeting}</p>
                    <p class="leading-relaxed mb-3">我是 IntiMate 愛心密語，你的貼心輔導夥伴。</p>
                    <div class="bg-white/20 p-3 rounded-xl mb-2">
                        <p class="font-semibold mb-1">📊 你的評估結果：</p>
                        <p class="text-sm">答對 ${preTestResults.score} / ${preTestResults.total} 題 (${scorePercent}%)</p>
                        <p class="text-sm mt-1">${performanceMsg}</p>
                    </div>
                </div>
            `;
            container.appendChild(welcomeMessage);
            
            // 延遲顯示話題建議
            setTimeout(() => {
                showTopicSuggestion();
            }, 800);
        }
        
        // 顯示話題建議
        function showTopicSuggestion() {
            const container = document.getElementById('messages-container');
            
            let suggestionText = '';
            let suggestedTopic = '';
            
            if (preTestResults.wrongTopics.length > 0) {
                // 有答錯的題目，建議從弱點開始
                suggestedTopic = preTestResults.wrongTopics[0];
                suggestionText = `我注意到你在「<span class="font-bold">${suggestedTopic}</span>」這個主題可能需要多了解一些。`;
            } else {
                // 全對，建議一個適合的主題
                const topics = getRecommendedTopics();
                suggestedTopic = topics[0];
                suggestionText = `你的基礎很好！我建議我們可以聊聊「<span class="font-bold">${suggestedTopic}</span>」。`;
            }
            
            const suggestionMessage = document.createElement('div');
            suggestionMessage.className = 'flex justify-start message-slide-in';
            suggestionMessage.innerHTML = `
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                    <p class="text-sm font-bold mb-2 flex items-center">💝 IntiMate 愛心密語</p>
                    <p class="leading-relaxed mb-3">${suggestionText}</p>
                    <p class="text-sm mb-3">你想從這個話題開始討論嗎？</p>
                    <div class="flex space-x-2">
                        <button onclick="acceptTopicSuggestion('${suggestedTopic}')" 
                                class="flex-1 px-4 py-2 bg-white/90 hover:bg-white text-purple-600 font-semibold rounded-full transition duration-200 active:scale-95">
                            ✓ 好的，開始吧
                        </button>
                        <button onclick="showTopicOptions()" 
                                class="flex-1 px-4 py-2 bg-white/20 hover:bg-white/30 text-white font-semibold rounded-full transition duration-200 active:scale-95">
                            ✗ 我想選其他話題
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(suggestionMessage);
            container.scrollTop = container.scrollHeight;
        }
        
        // 獲取推薦話題列表（根據年齡和性別）
        function getRecommendedTopics() {
            let topics = [];
            
            // 根據年齡段推薦
            switch(userAge) {
                case '10-13':
                    topics = [
                        '青春期身體變化',
                        '個人衛生與清潔',
                        '情緒管理',
                        '保護個人隱私',
                        '認識友誼與界線'
                    ];
                    break;
                case '13-15':
                    topics = [
                        '青春期的情感變化',
                        '健康的人際關係',
                        '網路安全與隱私',
                        '自我保護與拒絕技巧',
                        '身體自主權',
                        '性別認同與探索'
                    ];
                    break;
                case '16-18':
                    topics = [
                        '親密關係與同意權',
                        '避孕方法與性健康',
                        '性傳染病預防',
                        '健康的戀愛關係',
                        '性別平等與尊重',
                        '心理健康與壓力'
                    ];
                    break;
            }
            
            // 根據性別微調（添加特定話題）
            if (userGender === 'male') {
                if (userAge === '10-13') topics.push('男生的青春期變化');
                if (userAge === '13-15') topics.push('處理青春期困擾');
                if (userAge === '16-18') topics.push('男性健康與責任');
            } else if (userGender === 'female') {
                if (userAge === '10-13') topics.push('女生的青春期變化');
                if (userAge === '13-15') topics.push('月經與經期保健');
                if (userAge === '16-18') topics.push('女性健康與安全');
            }
            
            return topics;
        }
        
        // 接受話題建議
        function acceptTopicSuggestion(topic) {
            // 顯示用戶選擇
            renderUserMessage(`好的，我想了解「${topic}」`);
            
            // 鎖定輸入
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            input.disabled = true;
            sendBtn.disabled = true;
            
            // AI 開始引導式討論
            startGuidedDiscussion(topic);
        }
        
        // 顯示話題選項
        function showTopicOptions() {
            const container = document.getElementById('messages-container');
            
            // 顯示用戶選擇
            renderUserMessage('我想選其他話題');
            
            const topics = getRecommendedTopics();
            
            setTimeout(() => {
                const optionsMessage = document.createElement('div');
                optionsMessage.className = 'flex justify-start message-slide-in';
                optionsMessage.innerHTML = `
                    <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                        <p class="text-sm font-bold mb-2 flex items-center">💝 IntiMate 愛心密語</p>
                        <p class="leading-relaxed mb-3">沒問題！以下是一些適合你的話題，選一個你最想了解的：</p>
                        <div class="space-y-2">
                            ${topics.slice(0, 5).map((topic, index) => `
                                <button onclick="selectTopic('${topic}')" 
                                        class="w-full px-4 py-3 bg-white/90 hover:bg-white text-purple-600 text-left font-medium rounded-xl transition duration-200 active:scale-95 flex items-center">
                                    <span class="mr-2">${index + 1}.</span>
                                    <span>${topic}</span>
                                </button>
                            `).join('')}
                            <button onclick="enableFreeChat()" 
                                    class="w-full px-4 py-3 bg-white/20 hover:bg-white/30 text-white text-left font-medium rounded-xl transition duration-200 active:scale-95 flex items-center">
                                <span class="mr-2">💬</span>
                                <span>我想自己提問</span>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(optionsMessage);
                container.scrollTop = container.scrollHeight;
            }, 500);
        }
        
        // 選擇話題
        function selectTopic(topic) {
            renderUserMessage(`我想了解「${topic}」`);
            
            // 鎖定輸入
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            input.disabled = true;
            sendBtn.disabled = true;
            
            startGuidedDiscussion(topic);
        }
        
        // 開始引導式討論
        async function startGuidedDiscussion(topic) {
            // 構建引導式對話的 prompt
            const guidedPrompt = `我想深入了解「${topic}」這個主題。請用引導式的方式和我討論，就像一位真人輔導員一樣：
1. 先從基礎概念開始，用簡單的方式解釋
2. 問我是否有相關的疑問或困惑
3. 根據我的回應繼續深入
4. 適時給予實用的建議和例子

請現在開始第一步，用溫暖友善的方式介紹這個主題。`;
            
            await streamAIResponse(guidedPrompt);
            
            // 解鎖輸入，讓用戶可以繼續對話
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
        
        // 啟用自由對話
        function enableFreeChat() {
            const container = document.getElementById('messages-container');
            
            renderUserMessage('我想自己提問');
            
            setTimeout(() => {
                const freeMessage = document.createElement('div');
                freeMessage.className = 'flex justify-start message-slide-in';
                freeMessage.innerHTML = `
                    <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                        <p class="text-sm font-bold mb-2 flex items-center">💝 IntiMate 愛心密語</p>
                        <p class="leading-relaxed">太好了！你可以問我任何關於性教育的問題，我會用心回答你。別擔心，這是個安全的空間，沒有愚蠢的問題。💭</p>
                    </div>
                `;
                container.appendChild(freeMessage);
                container.scrollTop = container.scrollHeight;
            }, 500);
            
            // 確保輸入框可用
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
        
        // --- Post-Test Functions ---
        let currentPostTestQuestion = 0;
        
        function startPostTest() {
            // 切換到 post-test 視圖
            document.getElementById('chat-mode-view').classList.add('hidden');
            document.getElementById('quiz-mode-view').classList.add('hidden');
            document.getElementById('post-test-view').classList.remove('hidden');
            document.getElementById('chat-input-container').classList.add('hidden');
            
            currentPostTestQuestion = 0;
            postTestResults = {
                score: 0,
                total: preTestQuestions.length,
                answers: []
            };
            
            renderPostTestQuestion();
        }
        
        function renderPostTestQuestion() {
            const content = document.getElementById('post-test-content');
            
            if (currentPostTestQuestion >= preTestQuestions.length) {
                // Post-test 完成
                showPostTestResults();
                return;
            }
            
            const q = preTestQuestions[currentPostTestQuestion];
            const progress = ((currentPostTestQuestion / preTestQuestions.length) * 100).toFixed(0);
            
            content.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-green-600">題目 ${currentPostTestQuestion + 1} / ${preTestQuestions.length}</span>
                        <span class="text-sm text-gray-500">${progress}%</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 md:p-6 rounded-2xl mb-4">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 mb-4">${q.question}</h3>
                    <div class="space-y-3">
                        ${q.options.map((option, index) => `
                            <button onclick="answerPostTest(${index})" 
                                    class="w-full p-4 text-left rounded-xl transition-all bg-white hover:bg-green-100 border-2 border-green-200 hover:border-green-400 text-gray-700 hover:text-gray-900 font-medium text-sm md:text-base">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function answerPostTest(selectedIndex) {
            const q = preTestQuestions[currentPostTestQuestion];
            const isCorrect = selectedIndex === q.correctAnswer;
            
            postTestResults.answers.push({
                questionId: q.id,
                topic: q.topic,
                correct: isCorrect,
                selectedAnswer: selectedIndex
            });
            
            if (isCorrect) {
                postTestResults.score++;
            }
            
            currentPostTestQuestion++;
            renderPostTestQuestion();
        }
        
        function showPostTestResults() {
            const content = document.getElementById('post-test-content');
            
            const preScore = preTestResults.score;
            const postScore = postTestResults.score;
            const total = preTestResults.total;
            const improvement = postScore - preScore;
            const improvementPercent = ((improvement / total) * 100).toFixed(0);
            
            const prePercent = Math.round((preScore / total) * 100);
            const postPercent = Math.round((postScore / total) * 100);
            
            let message = '';
            let emoji = '';
            
            if (improvement > 0) {
                emoji = '🎉';
                message = `太棒了！你進步了 ${improvement} 題！這證明你在使用 IntiMate 的過程中確實學到了新知識。`;
            } else if (improvement === 0) {
                emoji = '👍';
                message = '你保持了原有的水平。如果還有不清楚的地方，歡迎繼續向我提問！';
            } else {
                emoji = '💪';
                message = '別氣餒！學習是一個持續的過程，歡迎隨時回來複習和提問。';
            }
            
            content.innerHTML = `
                <div class="text-center space-y-6">
                    <div class="text-8xl mb-4">${emoji}</div>
                    <h3 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">
                        測驗完成！
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                        <div class="bg-purple-100 p-4 rounded-2xl">
                            <p class="text-sm text-purple-600 font-semibold mb-1">初測成績</p>
                            <p class="text-3xl font-bold text-purple-700">${prePercent}%</p>
                            <p class="text-xs text-gray-600">${preScore}/${total} 題</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-2xl">
                            <p class="text-sm text-green-600 font-semibold mb-1">現在成績</p>
                            <p class="text-3xl font-bold text-green-700">${postPercent}%</p>
                            <p class="text-xs text-gray-600">${postScore}/${total} 題</p>
                        </div>
                    </div>
                    
                    ${improvement !== 0 ? `
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-2xl border-2 border-green-200">
                            <p class="text-2xl font-bold ${improvement > 0 ? 'text-green-600' : 'text-orange-600'}">
                                ${improvement > 0 ? '+' : ''}${improvementPercent}%
                            </p>
                            <p class="text-sm text-gray-600">進步幅度</p>
                        </div>
                    ` : ''}
                    
                    <p class="text-base text-gray-700 leading-relaxed max-w-md mx-auto">${message}</p>
                    
                    <button onclick="returnToChat()" 
                            class="mt-6 px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold rounded-full transition duration-200 shadow-lg hover:shadow-xl active:scale-95">
                        💬 返回對話
                    </button>
                </div>
            `;
        }
        
        function returnToChat() {
            document.getElementById('post-test-view').classList.add('hidden');
            document.getElementById('chat-mode-view').classList.remove('hidden');
            document.getElementById('chat-input-container').classList.remove('hidden');
        }
        
        // --- 核心配置 ---
        let currentMode = 'chat'; 
        
        // 關鍵：指向 Vercel 部署的 Serverless Function 路徑
        // Vercel 會自動將 /api/chat 映射到您部署的 chat.js 檔案
        const API_URL = '/api/chat'; 
        
        // 動態生成系統指令，根據使用者的年齡和性別
        function getSystemInstruction() {
            let ageContext = '';
            let genderContext = '';
            
            // 根據年齡段調整語氣和內容深度
            switch(userAge) {
                case '10-13':
                    ageContext = '你正在與一位10-13歲的青少年對話（探索期 / 基礎認知階段）。請使用溫和、基礎、具體的語言，避免專業術語，重點在於身體的初級變化、個人衛生與隱私界線。強調告訴家長或可信任的大人的重要性。';
                    break;
                case '13-15':
                    ageContext = '你正在與一位13-15歲的青少年對話（過渡期 / 社會認知階段）。請使用中立、實用的語言，專注於人際關係的健康互動、網路安全、以及性行為後果的初步認知。語氣要友善、不評判。';
                    break;
                case '16-18':
                    ageContext = '你正在與一位16-18歲的青少年對話（成熟期 / 關係與倫理階段）。請使用成熟、深入、倫理的語言，重點在於同意權的法律與倫理責任、避孕、STI預防，以及個人身份的深入探索。';
                    break;
            }
            
            // 根據性別提供更相關的建議
            switch(userGender) {
                case 'male':
                    genderContext = '對方自認為男性。在提供建議時，可以特別關注男性生理變化、心理健康、尊重他人界線等主題，但保持內容的包容性。';
                    break;
                case 'female':
                    genderContext = '對方自認為女性。在提供建議時，可以特別關注女性生理變化、經期健康、人身安全等主題，但保持內容的包容性。';
                    break;
                case 'other':
                    genderContext = '對方自認為其他性別認同。請特別注重包容性、多元性別認同的尊重，並提供非二元性別視角的資訊。';
                    break;
                case 'prefer-not-to-say':
                    genderContext = '對方選擇不透露性別。請提供中性、包容所有性別的資訊，不做任何性別假設。';
                    break;
            }
            
            // 添加 pre-test 弱點分析
            let weaknessContext = '';
            if (hasCompletedPreTest && preTestResults.wrongTopics.length > 0) {
                weaknessContext = `\n【學習需求分析】
根據初始評估測驗，使用者在以下主題答題不正確，需要特別加強：${preTestResults.wrongTopics.join('、')}
在對話中，當涉及這些主題時，請給予更詳細的解釋和引導，幫助使用者建立正確的認知。`;
            }
            
            return `你是 IntiMate 愛心密語，一位專業、中立且富有同理心的青少年性教育輔導夥伴。

【使用者背景】
${ageContext}

${genderContext}${weaknessContext}

【回答原則】
1. 以 IntiMate 的身份回答，使用溫暖、友善的語氣
2. 回答必須簡潔、安全、客觀，並使用適合對方年齡的語言
3. 避免給予醫療建議，建議就醫時需要請他們諮詢專業醫療人員
4. 始終強調同意權、個人安全和尊重他人的重要性
5. 保持非評判性態度，尊重多元性別認同和性取向
6. 如遇到不適合該年齡層的問題，溫和地引導並建議尋求成年人協助
7. 當使用者詢問與其弱點主題相關的問題時，提供更深入的說明和實例`;
        }

        // --- 測驗相關變數與題庫 ---
        let currentQuestionIndex = 0;
        let currentScore = 0;
        const quizQuestions = [
            {
                question: "1. 青春期身體發育的開始通常由什麼激素觸發？",
                options: ["雌激素 (Estrogen)", "睪固酮 (Testosterone)", "生長激素 (Growth Hormone)", "胰島素 (Insulin)"],
                correctAnswer: "雌激素 (Estrogen)",
                explanation: "青春期發育是由腦下垂體釋放的激素刺激卵巢或睪丸產生雌激素或睪酮所觸發的。"
            },
            {
                question: "2. 什麼是『同意權 (Consent)』的關鍵要素？",
                options: ["只需要保持沉默即可", "必須是自願、清晰且持續的", "只需要成年人同意", "必須是單方面的"],
                correctAnswer: "必須是自願、清晰且持續的",
                explanation: "同意必須是自願給予的、清晰明確的，並且可以隨時撤回（持續性）。"
            },
            {
                question: "3. 網路親密行為中最常見的風險是什麼？",
                options: ["手機電量不足", "圖片檔案過大", "失去對照片和訊息的控制權", "上傳速度慢"],
                correctAnswer: "失去對照片和訊息的控制權",
                explanation: "一旦私密內容發送出去，就永遠無法保證它不會被複製、分享或濫用。"
            },
            {
                question: "4. 以下哪項不是性傳染病（STI）的預防方法？",
                options: ["使用保險套", "接種疫苗（如 HPV）", "定期檢查", "共用牙刷"],
                correctAnswer: "共用牙刷",
                explanation: "共用牙刷與性傳染病預防無關。安全措施包括使用屏障、接種疫苗和定期篩檢。"
            },
            {
                question: "5. 如果對自己的性傾向或性別認同感到困惑，最健康的下一步是？",
                options: ["自己隱藏起來，不要告訴任何人", "尋求值得信任的成年人或專業人士諮詢", "立刻做出決定並公開", "在網路上尋找陌生人討論"],
                correctAnswer: "尋求值得信任的成年人或專業人士諮詢",
                explanation: "尋求專業輔導或與值得信任的成年人交流，是探索個人身份的最佳方式。"
            }
        ];


        // --- 主要功能邏輯 ---

        async function sendMessage() {
            if (currentMode === 'quiz') return; 

            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            renderUserMessage(message);
            input.value = '';
            
            // 鎖定輸入和發送按鈕
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            await streamAIResponse(message);

            // 解鎖輸入和發送按鈕
            input.disabled = false;
            document.getElementById('send-btn').disabled = false;
            input.focus();
        }

        // 串流 AI 回應 (呼叫 Vercel 代理)
        async function streamAIResponse(prompt) {
            const container = document.getElementById('messages-container');
            const aiMessage = document.createElement('div');
            aiMessage.className = 'flex justify-start message-slide-in';
            aiMessage.innerHTML = `
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-2xl rounded-tl-sm max-w-lg shadow-xl">
                    <p class="text-sm font-bold mb-2 flex items-center">💝 IntiMate 愛心密語</p>
                    <div id="ai-response-${Date.now()}" class="text-base leading-relaxed"><span class="pulse-animation">💭 思考中...</span></div>
                </div>
            `;
            container.appendChild(aiMessage);
            const responseElement = aiMessage.querySelector('div.text-base');

            // 滾動到底部
            container.scrollTop = container.scrollHeight;

            try {
                // 1. 向 Vercel 代理發送請求（使用動態生成的系統指令）
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // 將 Gemini 所需的結構（包括根據使用者資料定制的系統指令）發送給 Vercel 代理
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: getSystemInstruction() }] }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    responseElement.innerHTML = `<span class="text-red-400">連線錯誤或密鑰無效:</span> 請檢查代理伺服器或 Vercel 環境變數。`;
                    return;
                }
                
                // 2. 處理串流
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                
                responseElement.textContent = ''; // 清除 '...思考中'
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // Vercel 代理會將原始回應串流轉發回來
                    const chunk = decoder.decode(value, { stream: true });
                    responseElement.textContent += chunk;
                    container.scrollTop = container.scrollHeight;
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                responseElement.innerHTML = `<span class="text-red-400">網路或代理故障:</span> 請檢查連線或 Vercel 部署。`;
            }
        }

        // 渲染使用者訊息 (與先前版本相同)
        function renderUserMessage(text) {
            const container = document.getElementById('messages-container');
            const messageElement = document.createElement('div');
            messageElement.className = 'flex justify-end message-slide-in';
            messageElement.innerHTML = `
                <div class="bg-gradient-to-br from-blue-500 to-cyan-400 text-white p-4 rounded-2xl rounded-br-sm max-w-lg shadow-xl">
                    <p class="text-base leading-relaxed font-medium">${text}</p>
                </div>
            `;
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        // 綁定 Enter 鍵 (與先前版本相同)
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- 測驗模式邏輯 (與先前版本相同) ---
        function toggleMode() {
            const chatView = document.getElementById('chat-mode-view');
            const quizView = document.getElementById('quiz-mode-view');
            const toggleBtn = document.getElementById('mode-toggle-btn');
            const inputContainer = document.getElementById('chat-input-container');
            const quizPrompt = document.getElementById('quiz-prompt');
            const modeDisplay = document.getElementById('mode-display');

            if (currentMode === 'chat') {
                currentMode = 'quiz';
                chatView.classList.add('hidden');
                quizView.classList.remove('hidden');
                toggleBtn.innerHTML = '💬 返回';
                inputContainer.classList.add('hidden');
                quizPrompt.classList.remove('hidden');
                
                currentQuestionIndex = 0;
                currentScore = 0;
                renderQuiz();

            } else {
                currentMode = 'chat';
                chatView.classList.remove('hidden');
                quizView.classList.add('hidden');
                toggleBtn.innerHTML = '🎯 測驗';
                inputContainer.classList.remove('hidden');
                quizPrompt.classList.add('hidden');
            }
        }

        function renderQuiz() {
            const quizContent = document.getElementById('quiz-content');

            if (currentQuestionIndex >= quizQuestions.length) {
                const scorePercent = Math.round((currentScore / quizQuestions.length) * 100);
                const emoji = scorePercent >= 80 ? '🎉' : scorePercent >= 60 ? '👍' : '💪';
                quizContent.innerHTML = `
                    <div class="text-center p-8 bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl border-2 border-purple-300">
                        <div class="text-6xl mb-4">${emoji}</div>
                        <h3 class="text-3xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">測驗完成！</h3>
                        <p class="text-xl mb-4 text-gray-700">您的最終分數是：</p>
                        <div class="text-5xl font-extrabold bg-gradient-to-r from-blue-600 to-cyan-500 bg-clip-text text-transparent mb-4">${currentScore} / ${quizQuestions.length}</div>
                        <p class="text-lg text-gray-600 mb-6">掌握度：${scorePercent}% 💯</p>
                        <button onclick="toggleMode()" class="mt-4 px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold rounded-full transition duration-200 shadow-lg hover:shadow-xl active:scale-95">
                            💬 返回對話模式
                        </button>
                    </div>
                `;
                return;
            }

            const questionData = quizQuestions[currentQuestionIndex];
            const optionsContainer = document.createElement('div');
            optionsContainer.id = 'quiz-options';
            optionsContainer.className = 'mt-4 space-y-3';
            
            let optionsHTML = '';
            questionData.options.forEach((option, i) => {
                optionsHTML += `
                    <button onclick="checkAnswer(${i})" 
                            id="option-btn-${i}"
                            class="quiz-option-btn w-full p-5 my-2 text-left rounded-2xl transition-all 
                                   bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 
                                   border-2 border-purple-300 hover:border-purple-400
                                   disabled:opacity-75 disabled:cursor-not-allowed text-base font-semibold shadow-md hover:shadow-lg
                                   transform hover:scale-105 active:scale-95 text-gray-800">
                        <span class="text-purple-600">${String.fromCharCode(65 + i)}.</span> ${option}
                    </button>
                `;
            });

            quizContent.innerHTML = `
                <div class="mb-6">
                    <p class="text-sm font-semibold text-purple-600 mb-3 bg-purple-100 inline-block px-4 py-2 rounded-full">📊 第 ${currentQuestionIndex + 1} 題 / 共 ${quizQuestions.length} 題</p>
                    <h3 class="text-xl font-bold text-gray-800 leading-relaxed">${questionData.question}</h3>
                </div>
                ${optionsHTML}
            `;
        }

        function checkAnswer(selectedIndex) {
            const question = quizQuestions[currentQuestionIndex];
            const isCorrect = question.correctAnswer === question.options[selectedIndex];
            const optionsContainer = document.getElementById('quiz-options');
            const buttons = optionsContainer.querySelectorAll('button');

            buttons.forEach(button => {
                button.disabled = true;
                button.classList.remove('hover:from-purple-200', 'hover:to-pink-200', 'hover:scale-105', 'hover:border-purple-400'); 
            });

            buttons.forEach((button, index) => {
                if (index === selectedIndex) {
                    if (isCorrect) {
                        button.className = 'quiz-option-btn w-full p-5 my-2 text-left rounded-2xl transition-all bg-gradient-to-r from-green-400 to-emerald-500 ring-4 ring-green-300 text-white font-bold shadow-xl';
                        button.innerHTML = '✅ ' + button.innerHTML;
                    } else {
                        button.className = 'quiz-option-btn w-full p-5 my-2 text-left rounded-2xl transition-all bg-gradient-to-r from-red-400 to-pink-500 ring-4 ring-red-300 text-white font-bold shadow-xl';
                        button.innerHTML = '❌ ' + button.innerHTML;
                    }
                }
                
                if (question.options[index] === question.correctAnswer && index !== selectedIndex) {
                    button.className = 'quiz-option-btn w-full p-5 my-2 text-left rounded-2xl transition-all bg-gradient-to-r from-green-500 to-emerald-600 ring-4 ring-green-400 text-white font-bold shadow-xl';
                    button.innerHTML = '✅ ' + button.innerHTML;
                }
            });

            if (isCorrect) {
                currentScore++;
            }

            setTimeout(() => {
                currentQuestionIndex++;
                renderQuiz();
            }, 2000); 
        }

    </script>
</body>
</html>
